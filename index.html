<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,minimal-ui,viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Colizeum Tower Game üéÑ</title>
  <link rel="icon" type="image/x-icon" href="./assets/favicon.png">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box
    }

    img {
      width: 100%
    }

    html {
      background: #fff;
      height: 100%
    }

    body {
      font-family: "Helvetica Neue", Arial, Helvetica, sans-serif;
      margin: 0 auto;
      text-align: center;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      position: relative;
      overflow: hidden;
    }

    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url(assets/main-bg.png) center/cover;
      opacity: 0.3;
      z-index: 0;
    }

    body>* {
      position: relative;
      z-index: 1;
    }

    #canvas {
      position: fixed;
      left: 0;
      top: 0;
      right: 0;
      bottom: 0;
      margin: auto;
      z-index: 10
    }

    a {
      text-decoration: none
    }

    li,
    ol,
    ul {
      list-style-type: none;
      padding: 0;
      margin: 0
    }

    .hide {
      display: none
    }

    .clear {
      clear: both
    }

    /* Loading */
    .loading {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100%;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 9999;
    }

    .loading.hide {
      display: none !important;
    }

    .loading .main {
      width: 80%;
      max-width: 400px
    }

    .loading .title {
      font-size: 2rem;
      margin-bottom: 1rem;
      font-weight: bold
    }

    .loading .text {
      font-size: 1rem;
      margin-top: 1rem
    }

    .loading .bar {
      height: 20px;
      width: 100%;
      border: 3px solid #fff;
      border-radius: 10px;
      margin: 1rem 0;
      background: rgba(255, 255, 255, 0.2);
    }

    .loading .bar .percent {
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, #ffd700, #ff6b6b);
      border-radius: 7px;
      transition: width 0.3s;
    }

    /* Main Menu */
    .main-menu {
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      color: #fff;
      position: relative;
      z-index: 100;
    }

    .profile-screen {
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 2rem;
      color: #fff;
      position: relative;
      z-index: 100;
      overflow-y: auto;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    #profileScreen {
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 2rem;
      color: #fff;
      position: fixed !important;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100%;
      z-index: 10000 !important;
      overflow-y: auto;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .main-menu.hide {
      display: none !important;
    }

    .game-mode-selection.hide {
      display: none !important;
    }

    #profileScreen.hide {
      display: none !important;
    }

    #profileScreen:not(.hide) {
      display: flex !important;
      height: 100vh !important;
    }

    #mainMenu:not(.hide) {
      display: flex !important;
    }

    .main-menu h1 {
      font-size: 3rem;
      margin-bottom: 1rem;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      background: linear-gradient(45deg, #ffd700, #ff6b6b);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .main-menu .subtitle {
      font-size: 1.2rem;
      margin-bottom: 3rem;
      opacity: 0.9;
    }

    .menu-buttons {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      width: 100%;
      max-width: 300px;
    }

    .btn {
      padding: 1rem 2rem;
      border: none;
      border-radius: 15px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      color: #fff;
      text-transform: uppercase;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3)
    }

    .btn:active {
      transform: translateY(0)
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .btn-success {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .btn-info {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Profile */
    .profile {
      background: rgba(255, 255, 255, 0.98);
      border-radius: 25px;
      padding: 2.5rem;
      margin: 1.5rem auto;
      max-width: 450px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.1);
      display: block !important;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .profile.hide {
      display: none !important;
    }

    .profile-header {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 2px solid rgba(102, 126, 234, 0.2);
      position: relative;
    }

    .profile-header::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 60px;
      height: 3px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 2px;
    }

    .profile-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      color: #fff;
      font-weight: bold;
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
      border: 4px solid rgba(255, 255, 255, 0.3);
      transition: transform 0.3s;
    }

    .profile-avatar:hover {
      transform: scale(1.05);
    }

    .profile-info h3 {
      margin: 0;
      color: #333;
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.3rem;
    }

    .profile-info p {
      margin: 0;
      color: #666;
      font-size: 1rem;
      opacity: 0.8;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      padding: 1.5rem 1rem;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
      transition: transform 0.3s, box-shadow 0.3s;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
    }

    .stat-card:hover::before {
      opacity: 1;
    }

    .stat-card .value {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .stat-card .label {
      font-size: 0.85rem;
      opacity: 0.95;
      font-weight: 500;
      letter-spacing: 0.5px;
    }

    .leaderboard-section {
      width: 100%;
    }

    #leaderboardList::-webkit-scrollbar {
      width: 6px;
    }

    #leaderboardList::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 10px;
    }

    #leaderboardList::-webkit-scrollbar-thumb {
      background: rgba(102, 126, 234, 0.5);
      border-radius: 10px;
    }

    #leaderboardList::-webkit-scrollbar-thumb:hover {
      background: rgba(102, 126, 234, 0.7);
    }

    .bonus-info {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: #fff;
      padding: 1.5rem;
      border-radius: 15px;
      margin-top: 1.5rem;
      text-align: center;
      box-shadow: 0 8px 20px rgba(245, 87, 108, 0.3);
      transition: transform 0.3s;
    }

    .bonus-info:hover {
      transform: translateY(-3px);
    }

    .bonus-info.available {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      box-shadow: 0 8px 20px rgba(17, 153, 142, 0.3);
    }

    .bonus-info>div:first-child {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    .bonus-info .countdown {
      font-size: 1rem;
      opacity: 0.95;
    }

    .bonus-history-section {
      width: 100%;
      margin-top: 2rem;
    }

    .bonus-history-section h3 {
      color: #333;
      margin-bottom: 1rem;
      text-align: center;
      text-shadow: none;
      font-size: 1.3rem;
      font-weight: 700;
    }

    .leaderboard-section h3 {
      color: #333;
      margin-bottom: 1rem;
      text-align: center;
      text-shadow: none;
      font-size: 1.3rem;
      font-weight: 700;
    }

    #bonusHistoryList {
      background: rgba(255, 255, 255, 0.98);
      border-radius: 15px;
      padding: 1rem;
      max-height: 300px;
      overflow-y: auto;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }

    #bonusHistoryList::-webkit-scrollbar {
      width: 6px;
    }

    #bonusHistoryList::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 10px;
    }

    #bonusHistoryList::-webkit-scrollbar-thumb {
      background: rgba(102, 126, 234, 0.5);
      border-radius: 10px;
    }

    #bonusHistoryList::-webkit-scrollbar-thumb:hover {
      background: rgba(102, 126, 234, 0.7);
    }

    .bonus-info .countdown {
      font-size: 0.9rem;
      margin-top: 0.5rem;
      opacity: 0.9;
    }

    /* Game Mode Selection */
    .game-mode-selection {
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      color: #fff;
    }

    .mode-cards {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      width: 100%;
      max-width: 400px;
      margin-top: 2rem;
    }

    .mode-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 2rem;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .mode-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    .mode-card.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
      user-select: none;
    }

    .mode-card.disabled:hover {
      transform: none;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .mode-card h3 {
      color: #333;
      margin-bottom: 0.5rem;
      font-size: 1.5rem;
    }

    .mode-card p {
      color: #666;
      margin-bottom: 1rem;
    }

    .mode-card .badge {
      display: inline-block;
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: bold;
      margin-top: 0.5rem;
    }

    .badge-success {
      background: #38ef7d;
      color: #fff;
    }

    .badge-warning {
      background: #ffd700;
      color: #333;
    }

    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background: #fff;
      border-radius: 20px;
      padding: 2rem;
      max-width: 400px;
      width: 90%;
      text-align: center;
    }

    .modal-content h2 {
      margin-bottom: 1rem;
      color: #333;
    }

    .modal-content p {
      margin-bottom: 1.5rem;
      color: #666;
    }

    .modal-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    /* Game Over Modal */
    .game-over-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000 !important;
      pointer-events: auto;
    }

    .game-over-modal.hide {
      display: none;
    }

    .game-over-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 20px;
      padding: 2rem;
      max-width: 400px;
      width: 90%;
      text-align: center;
      color: #fff;
      position: relative;
      z-index: 1001;
      pointer-events: auto;
    }

    .game-over-content .btn {
      pointer-events: auto !important;
      cursor: pointer;
      z-index: 10002;
      position: relative;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    .game-over-modal * {
      pointer-events: auto;
    }

    .game-over-modal.hide * {
      pointer-events: none;
    }

    .game-over-content h2 {
      font-size: 2rem;
      margin-bottom: 1rem;
    }

    .game-over-content .score {
      font-size: 3rem;
      font-weight: bold;
      margin: 1rem 0;
      color: #ffd700;
    }

    .game-over-content .bonus-earned {
      background: rgba(255, 255, 255, 0.2);
      padding: 1rem;
      border-radius: 10px;
      margin: 1rem 0;
      font-size: 1.2rem;
    }

    /* Canvas Container */
    #canvas-container {
      position: fixed;
      left: 0;
      top: 0;
      right: 0;
      bottom: 0;
      margin: auto;
      z-index: 1;
    }

    /* Pause Button - –≤ –ª–µ–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É canvas */
    .pause-button {
      position: absolute;
      top: 10px;
      left: 10px;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.9) 0%, rgba(118, 75, 162, 0.9) 100%);
      border: 2px solid rgba(255, 255, 255, 0.8);
      color: #fff;
      font-size: 1.3rem;
      cursor: pointer;
      z-index: 10000;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s, opacity 0.2s;
      pointer-events: auto;
      backdrop-filter: blur(5px);
    }

    .pause-button:active {
      transform: scale(0.95);
    }

    .pause-button:hover {
      transform: scale(1.1);
    }

    .pause-button.hide {
      display: none;
    }

    @font-face {
      font-family: wenxue;
      src: url(assets/wenxue.eot);
      src: url(assets/wenxue.eot), url(assets/wenxue.woff), url(assets/wenxue.ttf), url(assets/wenxue.svg)
    }

    .font-wenxue {
      font-family: wenxue
    }

    /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
    @media (max-width: 768px) {
      body {
        font-size: 14px;
      }

      .main-menu {
        padding: 1rem;
      }

      .main-menu h1 {
        font-size: 2rem;
        margin-bottom: 0.5rem;
      }

      .main-menu .subtitle {
        font-size: 0.9rem;
        margin-bottom: 1.5rem;
      }

      .menu-buttons {
        max-width: 100%;
        padding: 0 1rem;
        gap: 0.8rem;
      }

      .btn {
        font-size: 1rem;
        padding: 1rem 1.5rem;
        min-height: 48px;
        /* –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        touch-action: manipulation;
        /* –£–±–∏—Ä–∞–µ—Ç –∑–∞–¥–µ—Ä–∂–∫—É –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
      }

      .game-mode-selection {
        padding: 1rem;
      }

      .game-mode-selection h1 {
        font-size: 1.5rem;
        margin-bottom: 1rem;
      }

      .mode-cards {
        gap: 1rem;
        max-width: 100%;
        padding: 0 0.5rem;
      }

      .mode-card {
        padding: 1.2rem;
        margin-bottom: 0;
        min-height: 120px;
        /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è */
        touch-action: manipulation;
      }

      .mode-card h3 {
        font-size: 1.2rem;
        margin-bottom: 0.5rem;
      }

      .mode-card p {
        font-size: 0.85rem;
        margin-bottom: 0.5rem;
      }

      .mode-card .badge {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
      }

      .profile {
        padding: 1.2rem;
        margin: 0.5rem;
        max-width: 100%;
        border-radius: 15px;
      }

      .profile-header {
        margin-bottom: 1rem;
      }

      .profile-avatar {
        width: 50px;
        height: 50px;
        font-size: 1.2rem;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
      }

      .stat-card {
        padding: 0.8rem;
      }

      .game-over-content {
        padding: 1.5rem;
        max-width: 95%;
        margin: 1rem;
      }

      .game-over-content h2 {
        font-size: 1.5rem;
        margin-bottom: 1rem;
      }

      .modal-buttons {
        flex-direction: column;
        gap: 0.8rem;
      }

      .pause-button {
        width: 45px;
        height: 45px;
        font-size: 1.2rem;
        top: 8px;
        left: 8px;
        touch-action: manipulation;
      }

      #btnProfileFromMode {
        margin-top: 1rem;
        width: 100%;
        max-width: 100%;
      }
    }

    @media (max-width: 480px) {
      body {
        font-size: 13px;
      }

      .main-menu h1 {
        font-size: 1.5rem;
      }

      .main-menu .subtitle {
        font-size: 0.85rem;
      }

      .btn {
        font-size: 0.9rem;
        padding: 0.9rem 1.2rem;
        min-height: 44px;
      }

      .game-mode-selection h1 {
        font-size: 1.3rem;
      }

      .mode-card {
        padding: 1rem;
        min-height: 110px;
      }

      .mode-card h3 {
        font-size: 1.1rem;
      }

      .mode-card p {
        font-size: 0.8rem;
      }

      .pause-button {
        width: 40px;
        height: 40px;
        font-size: 1rem;
        top: 5px;
        left: 5px;
      }

      .game-over-content {
        padding: 1.2rem;
      }

      .game-over-content h2 {
        font-size: 1.3rem;
      }
    }

    /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ */
    .mode-card,
    .btn,
    .pause-button {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      user-select: none;
      -webkit-user-select: none;
    }
  </style>
</head>

<body>
  <div id="canvas-container" class="hide">
    <canvas id="canvas"></canvas>
    <!-- Pause Button - –≤ –ª–µ–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É canvas -->
    <button id="btnPause" class="pause-button hide" title="–ü–∞—É–∑–∞ (Esc)">‚è∏Ô∏è</button>
  </div>

  <!-- Loading Screen -->
  <div class="loading" id="loading">
    <div class="main">
      <div class="title">üéÑ Colizeum Tower Game</div>
      <div class="bar">
        <div class="percent" id="loadingPercent"></div>
      </div>
      <div class="text" id="loadingText">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
  </div>

  <!-- Main Menu -->
  <div class="main-menu hide" id="mainMenu">
    <h1>üéÑ Colizeum Tower</h1>
    <p class="subtitle">–ù–æ–≤–æ–≥–æ–¥–Ω—è—è –∏–≥—Ä–∞ –¥–ª—è –∫–ª—É–±–∞!</p>
    <div class="menu-buttons">
      <button class="btn btn-info" id="btnProfile">üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</button>
    </div>
  </div>

  <!-- Profile -->
  <div class="profile-screen hide" id="profileScreen">
    <div class="profile">
      <div class="profile-header">
        <div class="profile-avatar" id="profileAvatar">üë§</div>
        <div class="profile-info">
          <h3 id="profileName">–ó–∞–≥—Ä—É–∑–∫–∞...</h3>
          <p id="profileUsername">@username</p>
        </div>
      </div>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="value" id="statGames">0</div>
          <div class="label">–ò–≥—Ä</div>
        </div>
        <div class="stat-card">
          <div class="value" id="statBestScore">0</div>
          <div class="label">–õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
        </div>
        <div class="stat-card">
          <div class="value" id="statBonuses">0</div>
          <div class="label">–ë–æ–Ω—É—Å–æ–≤</div>
        </div>
        <div class="stat-card">
          <div class="value" id="statRank">-</div>
          <div class="label">–ú–µ—Å—Ç–æ –≤ —Ç–æ–ø–µ</div>
        </div>
      </div>
      <div class="bonus-info" id="bonusInfo">
        <div>üéÅ –ò–≥—Ä–∞ –∑–∞ –±–æ–Ω—É—Å—ã</div>
        <div class="countdown" id="bonusCountdown">–ü—Ä–æ–≤–µ—Ä–∫–∞...</div>
      </div>

      <!-- –û–±–º–µ–Ω –±–æ–Ω—É—Å–æ–≤ -->
      <div class="bonus-exchange-section"
        style="margin-top: 2rem; background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 1.5rem;">
        <h3 style="color: #333; margin-bottom: 1rem; text-align: center; font-weight: 700;">üí∞ –û–±–º–µ–Ω –±–æ–Ω—É—Å–æ–≤</h3>
        <p style="color: #666; font-size: 0.9rem; text-align: center; margin-bottom: 1rem;">
          –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–Ω—É—Å–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–ø–æ–ª–Ω–∏—Ç—å —Å—á–µ—Ç –≤ –∫–ª—É–±–µ –Ω–∞ 50% –æ—Ç —Å—É–º–º—ã –±–æ–Ω—É—Å–æ–≤
        </p>
        <div style="display: flex; gap: 0.5rem; align-items: center; justify-content: center;">
          <input type="number" id="exchangeBonusesInput" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–æ–Ω—É—Å–æ–≤"
            style="flex: 1; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; max-width: 200px;"
            min="1" max="500">
          <button class="btn btn-primary" id="btnExchangeBonuses" style="padding: 0.75rem 1.5rem; white-space: nowrap;">
            –û–±–º–µ–Ω—è—Ç—å
          </button>
        </div>
        <div id="exchangeMessage"
          style="margin-top: 1rem; text-align: center; color: #667eea; font-weight: 600; display: none;"></div>
      </div>

      <!-- –ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä –∑–∞ –±–æ–Ω—É—Å—ã -->
      <div class="bonus-history-section" style="margin-top: 2rem;">
        <h3 style="color: #333; margin-bottom: 1rem; text-align: center; font-weight: 700;">üìú –ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä –∑–∞ –±–æ–Ω—É—Å—ã
        </h3>
        <div id="bonusHistoryList"
          style="background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 1rem; max-height: 300px; overflow-y: auto;">
          <div style="text-align: center; padding: 1rem; color: #666;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
      </div>

      <!-- –ú–∏—Ä–æ–≤–æ–π —Ç–æ–ø -->
      <div class="leaderboard-section" style="margin-top: 2rem;">
        <h3 style="color: #333; margin-bottom: 1rem; text-align: center; font-weight: 700;">üèÜ –ú–∏—Ä–æ–≤–æ–π —Ç–æ–ø</h3>
        <div id="leaderboardList"
          style="background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 1rem; max-height: 300px; overflow-y: auto;">
          <div style="text-align: center; padding: 1rem; color: #666;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
      </div>
    </div>
    <button class="btn btn-primary" id="btnBackFromProfile"
      style="margin-top: 2rem; margin-bottom: 1rem; width: 100%; max-width: 450px;">‚Üê –ö –≤—ã–±–æ—Ä—É —Ä–µ–∂–∏–º–∞</button>
  </div>

  <!-- Game Mode Selection -->
  <div class="game-mode-selection hide" id="gameModeSelection">
    <h1>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º –∏–≥—Ä—ã</h1>
    <div class="mode-cards">
      <div class="mode-card" id="modeNormal">
        <h3>üéÆ –û–±—ã—á–Ω–∞—è –∏–≥—Ä–∞</h3>
        <p>–ò–≥—Ä–∞–π—Ç–µ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π, —É–ª—É—á—à–∞–π—Ç–µ —Å–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!</p>
        <span class="badge badge-success">–ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π</span>
      </div>
      <div class="mode-card" id="modeBonus">
        <h3>üéÅ –ò–≥—Ä–∞ –∑–∞ –±–æ–Ω—É—Å—ã</h3>
        <p>–û–¥–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞ –≤ —Å—É—Ç–∫–∏. –ü–æ–ª—É—á–∏—Ç–µ –±–æ–Ω—É—Å—ã –∑–∞ —Ö–æ—Ä–æ—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!</p>
        <span class="badge badge-warning" id="bonusBadge">–î–æ—Å—Ç—É–ø–Ω–æ</span>
        <div id="bonusModeInfo" style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;"></div>
      </div>
    </div>
    <button class="btn btn-info" id="btnProfileFromMode" style="margin-top: 2rem;">üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</button>
  </div>

  <!-- Pause Modal -->
  <div class="game-over-modal hide" id="pauseModal">
    <div class="game-over-content">
      <h2>‚è∏Ô∏è –ü–∞—É–∑–∞</h2>
      <div class="modal-buttons" style="margin-top: 2rem;">
        <button class="btn btn-primary" id="btnResume">‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        <button class="btn btn-info" id="btnExitToMenu">üè† –í—ã–π—Ç–∏ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
      </div>
    </div>
  </div>

  <!-- Game Over Modal -->
  <div class="game-over-modal hide" id="gameOverModal">
    <div class="game-over-content">
      <h2>üéâ –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</h2>
      <div class="score" id="finalScore">0</div>
      <div id="bonusEarned" class="bonus-earned hide"></div>
      <div class="modal-buttons" style="margin-top: 2rem;">
        <button class="btn btn-primary" id="btnPlayAgain">–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
        <button class="btn btn-info" id="btnBackToMenu">–í –º–µ–Ω—é</button>
      </div>
    </div>
  </div>

  <script src="./dist/main.js?v=202411201015"></script>
  <script src="./assets/zepto-1.1.6.min.js"></script>
  <script>
    // API Configuration
    // API_BASE: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π origin –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
    // –î–ª—è production –∏–∑–º–µ–Ω–∏—Ç–µ –Ω–∞ URL –≤–∞—à–µ–≥–æ backend —Å–µ—Ä–≤–µ—Ä–∞
    const API_BASE = window.location.origin;
    // –ü—Ä–∏–º–µ—Ä –¥–ª—è production: const API_BASE = 'https://your-backend.onrender.com';
    let authToken = null;
    let currentUser = null;
    let currentGameType = 'normal';
    let game = null;
    let gameStart = false;
    let bonusStatusUpdateInterval = null; // –ò–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∏–≥—Ä—ã –∑–∞ –±–æ–Ω—É—Å—ã
    let bonusCountdownInterval = null; // –ò–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞ –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞
    let bonusNextAvailableTime = null; // –í—Ä–µ–º—è –∫–æ–≥–¥–∞ –∏–≥—Ä–∞ —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞
    let score = 0;
    let successCount = 0;
    let perfectCount = 0;
    let normalCount = 0;
    let currentBonuses = 0; // –¢–µ–∫—É—â–∏–µ –±–æ–Ω—É—Å—ã –≤ –∏–≥—Ä–µ
    let lastPerfectCount = 0;
    let previousPerfectCount = 0; // –ü—Ä–µ–¥—ã–¥—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ PERFECT_COUNT –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
    let lastTrackedSuccessCount = 0; // –ü–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç—Å–ª–µ–∂–µ–Ω–Ω—ã–π successCount –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
    let domReady = false;
    let canvasReady = false;
    let loadFinish = false;

    // Initialize
    function init() {
      // Check if we're in Telegram Web App
      if (window.Telegram && window.Telegram.WebApp) {
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
      }

      // Try to authenticate
      authenticateUser();

      // Setup event listeners
      setupEventListeners();

      // Initialize game
      initGame();
    }

    // Authentication
    async function authenticateUser() {
      try {
        // Check if we have initData from Telegram
        const urlParams = new URLSearchParams(window.location.search);
        const tgWebAppStartParam = urlParams.get('tgWebAppStartParam');

        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData) {
          const initData = window.Telegram.WebApp.initData;
          console.log('Telegram WebApp initData found, authenticating...');
          try {
            const response = await fetch(`${API_BASE}/api/auth/telegram`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ initData })
            });

            if (response.ok) {
              const data = await response.json();
              authToken = data.token;
              currentUser = data.user;
              localStorage.setItem('authToken', authToken);
              // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
              await loadUserInfo();
              updateUI();
              console.log('Authentication successful, user:', currentUser);
            } else {
              const errorData = await response.json().catch(() => ({}));
              console.error('Auth failed:', response.status, errorData);
            }
          } catch (err) {
            console.error('Auth request error:', err);
          }
        } else if (tgWebAppStartParam) {
          // Fallback: use start param for demo - —Å–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–ª—è –¥–µ–º–æ
          console.log('Using start param for demo, userId:', tgWebAppStartParam);
          // –î–ª—è –¥–µ–º–æ —Å–æ–∑–¥–∞–µ–º —Ñ–∏–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          try {
            const demoResponse = await fetch(`${API_BASE}/api/auth/telegram`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                initData: `user=%7B%22id%22%3A${tgWebAppStartParam}%2C%22first_name%22%3A%22Demo%22%7D&auth_date=${Math.floor(Date.now() / 1000)}&hash=demo`
              })
            });
            if (demoResponse.ok) {
              const data = await demoResponse.json();
              authToken = data.token;
              currentUser = data.user;
              localStorage.setItem('authToken', authToken);
              // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
              await loadUserInfo();
              updateUI();
            }
          } catch (e) {
            console.log('Demo auth failed, using stored token if available');
          }
        }

        // Check for stored token (–µ—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram –Ω–µ —É–¥–∞–ª–∞—Å—å)
        if (!authToken) {
          const storedToken = localStorage.getItem('authToken');
          if (storedToken) {
            authToken = storedToken;
            await loadUserInfo();
          }
        }
      } catch (err) {
        console.error('Auth error:', err);
      }
    }

    async function loadUserInfo() {
      if (!authToken) {
        console.log('No authToken, cannot load user info');
        return;
      }

      try {
        console.log('Loading user info with token:', authToken.substring(0, 20) + '...');
        const response = await fetch(`${API_BASE}/api/user/me`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });

        if (response.ok) {
          const data = await response.json();
          console.log('User info loaded:', data);
          currentUser = data.user;
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ –∫–∞–Ω–∞–ª
          if (currentUser && currentUser.isSubscribed === false && currentUser.channelLink) {
            showSubscriptionRequired(currentUser.channelLink);
            return;
          }
          
          updateUI();
        } else {
          const errorData = await response.json().catch(() => ({}));
          console.error('Load user info failed:', response.status, errorData);
          
          // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏
          if (response.status === 403 && errorData.channel) {
            showSubscriptionRequired(errorData.channel);
            return;
          }
          
          // –ù–µ —É–¥–∞–ª—è–µ–º —Ç–æ–∫–µ–Ω —Å—Ä–∞–∑—É, –≤–æ–∑–º–æ–∂–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞
          if (response.status === 401) {
            localStorage.removeItem('authToken');
            authToken = null;
          }
        }
      } catch (err) {
        console.error('Load user error:', err);
      }
    }

    function updateUI() {
      if (currentUser) {
        console.log('Updating UI with user:', currentUser);
        const firstName = currentUser.firstName || currentUser.first_name || '–ò–≥—Ä–æ–∫';
        const username = currentUser.username || '';

        const nameEl = $('#profileName');
        const usernameEl = $('#profileUsername');
        const avatarEl = $('#profileAvatar');

        console.log('Updating UI elements:', {
          nameEl: nameEl.length,
          usernameEl: usernameEl.length,
          avatarEl: avatarEl.length
        });

        nameEl.text(firstName);
        usernameEl.text(username ? `@${username}` : '');
        avatarEl.text(firstName[0].toUpperCase());

        console.log('Elements text after update - Name:', nameEl.text(), 'Username:', usernameEl.text(), 'Avatar:', avatarEl.text());
        console.log('UI updated - Name:', firstName, 'Username:', username, 'Avatar:', firstName[0].toUpperCase());
      } else {
        console.log('No currentUser to update UI');
      }
    }

    // Event Listeners
    function setupEventListeners() {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π touch
      $(document).on('click touchstart', '#btnProfile', function (e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('btnProfile clicked');
        showProfile();
      });

      $(document).on('click touchstart', '#btnProfileFromMode', function (e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('btnProfileFromMode clicked');
        showProfile();
      });

      $(document).on('click touchstart', '#btnBackFromProfile', function (e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('btnBackFromProfile clicked');
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
        $('#profileScreen').addClass('hide').css('display', 'none');
        $('.profile').removeClass('hide');
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞
        showGameModeSelection();
      });

      // Exchange bonuses
      $(document).on('click touchstart', '#btnExchangeBonuses', async function (e) {
        e.preventDefault();
        e.stopPropagation();

        const bonusesAmount = parseInt($('#exchangeBonusesInput').val());
        if (!bonusesAmount || bonusesAmount <= 0) {
          alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–æ–Ω—É—Å–æ–≤ –¥–ª—è –æ–±–º–µ–Ω–∞');
          return;
        }

        if (!authToken) {
          alert('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
          return;
        }

        try {
          const response = await fetch(`${API_BASE}/api/bonus/exchange`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({ bonusesAmount })
          });

          if (response.ok) {
            const data = await response.json();
            $('#exchangeMessage').text(data.message).css('display', 'block').css('color', '#667eea');
            $('#exchangeBonusesInput').val('');
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è
            await loadProfileData();
          } else {
            const error = await response.json();
            $('#exchangeMessage').text(error.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–º–µ–Ω–µ –±–æ–Ω—É—Å–æ–≤').css('display', 'block').css('color', '#e74c3c');
          }
        } catch (err) {
          console.error('Exchange bonuses error:', err);
          $('#exchangeMessage').text('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–º–µ–Ω–µ –±–æ–Ω—É—Å–æ–≤').css('display', 'block').css('color', '#e74c3c');
        }
      });

      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ä–µ–∂–∏–º–∞ –∏–≥—Ä—ã (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ touch –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö)
      $(document).on('click touchstart', '#modeNormal', function (e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('Normal mode clicked, gameStart:', gameStart);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞
        const gameModeSelection = $('#gameModeSelection');
        if (gameModeSelection.hasClass('hide') || gameModeSelection.css('display') === 'none') {
          console.log('Menu is hidden, ignoring click');
          return false;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–≥—Ä–∞ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞
        if (gameStart) {
          console.log('Game is already started, ignoring click');
          return false;
        }

        startGame('normal');
        return false;
      });

      $(document).on('click touchstart', '#modeBonus', function (e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('Bonus mode clicked, gameStart:', gameStart);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞
        const gameModeSelection = $('#gameModeSelection');
        if (gameModeSelection.hasClass('hide') || gameModeSelection.css('display') === 'none') {
          console.log('Menu is hidden, ignoring click');
          return false;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–≥—Ä–∞ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞
        if (gameStart) {
          console.log('Game is already started, ignoring click');
          return false;
        }

        // –ü–†–û–í–ï–†–ö–ê: –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞, –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É
        const modeBonus = $('#modeBonus');
        if (modeBonus.hasClass('disabled')) {
          console.log('Bonus game is disabled, cannot start');
          // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Ä–µ–º–µ–Ω–∏ –¥–æ—Å—Ç—É–ø–∞
          const bonusModeInfo = $('#bonusModeInfo').text();
          if (bonusModeInfo) {
            alert(`–ò–≥—Ä–∞ –∑–∞ –±–æ–Ω—É—Å—ã –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.\n${bonusModeInfo}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ!`);
          } else {
            alert('–ò–≥—Ä–∞ –∑–∞ –±–æ–Ω—É—Å—ã –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ!');
          }
          return false;
        }

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
        startGame('bonus');
        return false;
      });
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ Game Over –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π touch –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö)
      $(document).on('click touchstart', '#btnPlayAgain', function (e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('btnPlayAgain clicked');
        $('#gameOverModal').addClass('hide').css('display', 'none');

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∏–≥—Ä—ã –∑–∞ –±–æ–Ω—É—Å—ã –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º –º–µ–Ω—é (–µ—Å–ª–∏ –±—ã–ª–∞ –∏–≥—Ä–∞ –∑–∞ –±–æ–Ω—É—Å—ã)
        if (currentGameType === 'bonus') {
          updateBonusGameStatus();
        }

        showGameModeSelection();
      });

      $(document).on('click touchstart', '#btnBackToMenu', function (e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('btnBackToMenu clicked');
        $('#gameOverModal').addClass('hide').css('display', 'none');

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∏–≥—Ä—ã –∑–∞ –±–æ–Ω—É—Å—ã –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º –º–µ–Ω—é
        if (currentGameType === 'bonus') {
          updateBonusGameStatus();
        }

        showGameModeSelection();
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –ø–∞—É–∑—ã (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π touch)
      $(document).on('click touchstart', '#btnPause', function (e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('btnPause clicked');
        pauseGame();
      });

      $(document).on('click touchstart', '#btnResume', function (e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('btnResume clicked');
        resumeGame();
      });

      $(document).on('click touchstart', '#btnExitToMenu', function (e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('btnExitToMenu clicked');
        exitToMenu();
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∞–≤–∏—à–∏ Escape –¥–ª—è –ø–∞—É–∑—ã
      $(document).on('keydown', function (e) {
        if (e.key === 'Escape' && gameStart && !$('#pauseModal').hasClass('hide')) {
          resumeGame();
        } else if (e.key === 'Escape' && gameStart && $('#pauseModal').hasClass('hide') && $('#gameOverModal').hasClass('hide')) {
          pauseGame();
        }
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ canvas –¥–ª—è –ø–∞—É–∑—ã (–µ—Å–ª–∏ –∏–≥—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞)
      $('#canvas').on('click', function (e) {
        // –ù–µ —Å—Ç–∞–≤–∏–º –ø–∞—É–∑—É –ø—Ä–∏ –∫–ª–∏–∫–µ, —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Escape –∏–ª–∏ –∫–Ω–æ–ø–∫—É
      });
    }

    function showMainMenu() {
      // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —ç–∫—Ä–∞–Ω—ã
      $('#loading').addClass('hide').css('display', 'none');
      $('#mainMenu').addClass('hide').css('display', 'none');
      $('#profileScreen').addClass('hide').css('display', 'none');
      $('#canvas-container').addClass('hide');
      $('#canvas').addClass('hide');
      $('#profileScreen').addClass('hide');
      $('#btnPause').addClass('hide');
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞ –∏–≥—Ä—ã –≤–º–µ—Å—Ç–æ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
      showGameModeSelection();
    }

    function showProfile() {
      console.log('showProfile called');
      // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —ç–∫—Ä–∞–Ω—ã –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ
      $('#mainMenu').addClass('hide').css('display', 'none');
      $('#gameModeSelection').addClass('hide').css('display', 'none');
      $('.game-mode-selection').addClass('hide').css('display', 'none');
      
      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∏–≥—Ä—ã –∑–∞ –±–æ–Ω—É—Å—ã
      if (bonusStatusUpdateInterval) {
        clearInterval(bonusStatusUpdateInterval);
        bonusStatusUpdateInterval = null;
      }
      
      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞
      stopBonusCountdown();
      $('#canvas-container').addClass('hide');
      $('#canvas').addClass('hide');
      $('#loading').addClass('hide');
      $('#pauseModal').addClass('hide');
      $('#gameOverModal').addClass('hide');

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –ø—Ä–æ—Ñ–∏–ª—è —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º
      $('#profileScreen').removeClass('hide');
      $('.profile').removeClass('hide'); // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø—Ä–æ—Ñ–∏–ª—è –≤–∏–¥–Ω–æ
      $('#profileScreen').css({
        'display': 'flex',
        'z-index': '10000',
        'position': 'relative'
      });
      $('.profile').css('display', 'block'); // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ .profile –≤–∏–¥–µ–Ω
      console.log('Profile screen shown, display:', $('#profileScreen').css('display'), 'z-index:', $('#profileScreen').css('z-index'));
      console.log('Profile content visible:', $('.profile').css('display'), $('.profile').hasClass('hide'));

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è
      loadProfileData();
    }

    async function loadProfileData() {
      if (!authToken) {
        // –ï—Å–ª–∏ –Ω–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        $('#profileName').text('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
        $('#profileUsername').text('–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞');
        $('#statGames').text('0');
        $('#statBestScore').text('0');
        $('#statBonuses').text('0');
        $('#statRank').text('-');
        $('#bonusCountdown').text('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ –±–æ—Ç–∞');
        return;
      }

      try {
        // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        await loadUserInfo();

        // –ó–∞—Ç–µ–º –∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        const response = await fetch(`${API_BASE}/api/stats`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });

        if (response.ok) {
          const data = await response.json();
          console.log('Profile data loaded:', data);
          const stats = data.stats;
          const bonusInfo = data.bonusInfo;

          const gamesEl = $('#statGames');
          const bestScoreEl = $('#statBestScore');
          const bonusesEl = $('#statBonuses');
          const rankEl = $('#statRank');

          console.log('Updating stats elements:', {
            gamesEl: gamesEl.length,
            bestScoreEl: bestScoreEl.length,
            bonusesEl: bonusesEl.length,
            rankEl: rankEl.length
          });

          gamesEl.text(stats.games_count || 0);
          bestScoreEl.text(stats.best_score || 0);
          bonusesEl.text(stats.total_bonuses || 0);
          const rank = data.rank;
          rankEl.text(rank ? `#${rank}` : '-');

          console.log('Profile stats updated:', {
            games: stats.games_count,
            bestScore: stats.best_score,
            bonuses: stats.total_bonuses,
            rank: rank
          });
          console.log('Elements text after update - Games:', gamesEl.text(), 'BestScore:', bestScoreEl.text(), 'Bonuses:', bonusesEl.text(), 'Rank:', rankEl.text());

          // Update bonus info
          const bonusInfoEl = $('#bonusInfo');
          if (bonusInfo && bonusInfo.canPlay) {
            bonusInfoEl.addClass('available');
            $('#bonusCountdown').text('‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ —Å–µ–π—á–∞—Å!');
            bonusNextAvailableTime = null;
          } else if (bonusInfo) {
            bonusInfoEl.removeClass('available');
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –∫–æ–≥–¥–∞ –∏–≥—Ä–∞ —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è —Ç–∞–π–º–µ—Ä–∞
            bonusNextAvailableTime = new Date(bonusInfo.nextAvailable);
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä —Å—Ä–∞–∑—É
            updateBonusCountdown();
            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ç–∞–π–º–µ—Ä –∑–∞–ø—É—â–µ–Ω
            if (!bonusCountdownInterval) {
              startBonusCountdown();
            }
          } else {
            $('#bonusCountdown').text('–ü—Ä–æ–≤–µ—Ä–∫–∞...');
          }

          // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏–≥—Ä –∑–∞ –±–æ–Ω—É—Å—ã
          loadBonusHistory();

          // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∏—Ä–æ–≤–æ–π —Ç–æ–ø
          loadLeaderboard();

          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –æ–±–º–µ–Ω–∞ –±–æ–Ω—É—Å–æ–≤
          const currentBonuses = stats.total_bonuses || 0;
          $('#exchangeBonusesInput').attr('max', Math.min(currentBonuses, 500));
        } else {
          console.error('Stats API error:', response.status, response.statusText);
          // –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
          $('#profileName').text('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
          $('#profileUsername').text('–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ –±–æ—Ç–∞');
        }
      } catch (err) {
        console.error('Load profile error:', err);
        $('#profileName').text('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
        $('#profileUsername').text('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ');
      }
    }

    async function loadBonusHistory() {
      if (!authToken) {
        $('#bonusHistoryList').html('<div style="text-align: center; padding: 1rem; color: #666;">–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</div>');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/bonus/history?limit=10`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });

        if (response.ok) {
          const data = await response.json();
          displayBonusHistory(data.history);
        } else {
          $('#bonusHistoryList').html('<div style="text-align: center; padding: 1rem; color: #666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏</div>');
        }
      } catch (err) {
        console.error('Load bonus history error:', err);
        $('#bonusHistoryList').html('<div style="text-align: center; padding: 1rem; color: #666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏</div>');
      }
    }

    function displayBonusHistory(history) {
      const listEl = $('#bonusHistoryList');

      if (!history || history.length === 0) {
        listEl.html('<div style="text-align: center; padding: 1rem; color: #666;">–ü–æ–∫–∞ –Ω–µ—Ç –∏–≥—Ä –∑–∞ –±–æ–Ω—É—Å—ã</div>');
        return;
      }

      let html = '<div style="font-size: 0.85rem;">';

      history.forEach((game, index) => {
        const date = new Date(game.played_at);
        const dateStr = date.toLocaleDateString('ru-RU', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });

        html += `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid rgba(0, 0, 0, 0.08); transition: background 0.3s; border-radius: 8px; margin-bottom: 0.5rem; background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);">
            <div style="flex: 1;">
              <div style="font-weight: 700; color: #333; font-size: 1rem; margin-bottom: 0.3rem;">–ò–≥—Ä–∞ #${history.length - index}</div>
              <div style="font-size: 0.8rem; color: #666; opacity: 0.8;">${dateStr}</div>
            </div>
            <div style="text-align: right; margin-left: 1rem;">
              <div style="font-weight: 700; color: #667eea; font-size: 1.1rem; margin-bottom: 0.2rem;">${game.score || 0} –æ—á–∫–æ–≤</div>
              <div style="font-size: 0.75rem; color: #999; display: flex; align-items: center; justify-content: flex-end; gap: 0.3rem;">
                <span>${game.bonuses_earned || 0}</span>
                <span style="font-size: 1rem;">üéÅ</span>
              </div>
            </div>
          </div>
        `;
      });

      html += '</div>';
      listEl.html(html);
    }

    async function loadLeaderboard() {
      if (!authToken) return;

      try {
        const response = await fetch(`${API_BASE}/api/leaderboard?limit=10`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });

        if (response.ok) {
          const data = await response.json();
          displayLeaderboard(data.leaderboard, data.userRank, data.userBestScore);
        } else {
          $('#leaderboardList').html('<div style="text-align: center; padding: 1rem; color: #666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–ø–∞</div>');
        }
      } catch (err) {
        console.error('Load leaderboard error:', err);
        $('#leaderboardList').html('<div style="text-align: center; padding: 1rem; color: #666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–ø–∞</div>');
      }
    }

    function displayLeaderboard(leaderboard, userRank, userBestScore) {
      const listEl = $('#leaderboardList');

      if (!leaderboard || leaderboard.length === 0) {
        listEl.html('<div style="text-align: center; padding: 1rem; color: #666;">–ü–æ–∫–∞ –Ω–µ—Ç –∏–≥—Ä–æ–∫–æ–≤ –≤ —Ç–æ–ø–µ</div>');
        return;
      }

      let html = '<div style="font-size: 0.85rem;">';

      leaderboard.forEach((player, index) => {
        const isCurrentUser = player.best_score === userBestScore && userRank === index + 1;
        const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;
        const name = player.first_name || player.username || '–ò–≥—Ä–æ–∫';
        const username = player.username ? `@${player.username}` : '';

        html += `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.7rem; border-bottom: 1px solid #eee; ${isCurrentUser ? 'background: rgba(102, 126, 234, 0.1); font-weight: bold;' : ''}">
            <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1;">
              <span style="font-size: 1.1rem; min-width: 30px;">${medal}</span>
              <div>
                <div style="font-weight: ${isCurrentUser ? 'bold' : 'normal'}; color: #333;">${name}</div>
                ${username ? `<div style="font-size: 0.75rem; color: #666;">${username}</div>` : ''}
              </div>
            </div>
            <div style="text-align: right;">
              <div style="font-weight: bold; color: #667eea;">${player.best_score || 0}</div>
              <div style="font-size: 0.7rem; color: #999;">${player.total_bonuses || 0} üéÅ</div>
            </div>
          </div>
        `;
      });

      html += '</div>';
      listEl.html(html);
    }

    async function showGameModeSelection() {
      console.log('showGameModeSelection called, gameStart:', gameStart);

      // –ï—Å–ª–∏ –∏–≥—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞, –Ω–æ –º—ã —è–≤–Ω–æ —Ö–æ—Ç–∏–º –ø–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑ exitToMenu),
      // —Ç–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º gameStart
      if (gameStart) {
        console.log('Game is running, but showing menu anyway (forced)');
        gameStart = false;
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∏–¥–µ–Ω –ª–∏ canvas (–∏–≥—Ä–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è)
      const canvasVisible = !$('#canvas-container').hasClass('hide');
      // –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–∫–∞–∑ –º–µ–Ω—é, –µ—Å–ª–∏ gameStart —É–∂–µ —Å–±—Ä–æ—à–µ–Ω
      if (canvasVisible && gameStart) {
        console.log('Game is starting, not showing menu. gameStart:', gameStart, 'canvas visible:', canvasVisible);
        return;
      }

      console.log('Showing game mode selection');

      // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —ç–∫—Ä–∞–Ω—ã
      $('#mainMenu').addClass('hide').css('display', 'none');
      $('#profileScreen').addClass('hide').css('display', 'none');
      $('#canvas-container').addClass('hide');
      $('#canvas').addClass('hide');
      $('#btnPause').addClass('hide');
      $('#pauseModal').addClass('hide');
      $('#gameOverModal').addClass('hide');

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞
      $('#gameModeSelection').removeClass('hide').css('display', 'flex');

      console.log('Game mode selection shown');

      // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä —Å—Ä–∞–∑—É (–Ω–µ –¥–æ–∂–∏–¥–∞—è—Å—å –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞)
      // –ï—Å–ª–∏ bonusNextAvailableTime —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, —Ç–∞–π–º–µ—Ä –Ω–∞—á–Ω–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å—Ä–∞–∑—É
      startBonusCountdown();
      
      // Check bonus game availability (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
      updateBonusGameStatus().then(() => {
        // –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ç–∞–π–º–µ—Ä –∑–∞–ø—É—â–µ–Ω
        if (!bonusCountdownInterval) {
          startBonusCountdown();
        }
      }).catch(() => {
        // –î–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ç–∞–π–º–µ—Ä –∑–∞–ø—É—â–µ–Ω
        if (!bonusCountdownInterval) {
          startBonusCountdown();
        }
      });
      
      // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
      if (bonusStatusUpdateInterval) {
        clearInterval(bonusStatusUpdateInterval);
      }
      bonusStatusUpdateInterval = setInterval(() => {
        console.log('Auto-updating bonus game status...');
        updateBonusGameStatus();
      }, 60 * 1000); // –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∏–≥—Ä—ã –∑–∞ –±–æ–Ω—É—Å—ã
    async function updateBonusGameStatus() {
      if (!authToken) {
        return Promise.resolve();
      }

      try {
        const response = await fetch(`${API_BASE}/api/game/bonus/check`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });

        if (response.ok) {
          const bonusInfo = await response.json();
          const modeBonus = $('#modeBonus');
          const bonusBadge = $('#bonusBadge');
          const bonusModeInfo = $('#bonusModeInfo');

          if (bonusInfo.canPlay) {
            // –ò–≥—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ - —É–±–∏—Ä–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
            modeBonus.removeClass('disabled');
            modeBonus.css('pointer-events', 'auto');
            bonusBadge.text('‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ');
            bonusBadge.removeClass('badge-warning').addClass('badge-success');
            bonusModeInfo.text('');
            bonusNextAvailableTime = null;
            console.log('Bonus game is available');
          } else {
            // –ò–≥—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ - –±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            modeBonus.addClass('disabled');
            modeBonus.css('pointer-events', 'none');
            bonusBadge.removeClass('badge-success').addClass('badge-warning');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –∫–æ–≥–¥–∞ –∏–≥—Ä–∞ —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è —Ç–∞–π–º–µ—Ä–∞
            bonusNextAvailableTime = new Date(bonusInfo.nextAvailable);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä —Å—Ä–∞–∑—É
            updateBonusCountdown();
            
            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ç–∞–π–º–µ—Ä –∑–∞–ø—É—â–µ–Ω (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω)
            if (!bonusCountdownInterval) {
              startBonusCountdown();
            } else {
              // –ï—Å–ª–∏ —Ç–∞–π–º–µ—Ä —É–∂–µ –∑–∞–ø—É—â–µ–Ω, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ —Å—Ä–∞–∑—É
              updateBonusCountdown();
            }
            
            console.log(`Bonus game is not available, next available at ${bonusNextAvailableTime.toISOString()}`);
          }
        } else {
          // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–µ —É–¥–∞–ª—Å—è, –±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
          const modeBonus = $('#modeBonus');
          modeBonus.addClass('disabled');
          modeBonus.css('pointer-events', 'none');
          console.error('Failed to check bonus game status:', response.status);
        }
      } catch (err) {
        console.error('Check bonus game error:', err);
        // –ü—Ä–∏ –æ—à–∏–±–∫–µ –±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
        const modeBonus = $('#modeBonus');
        modeBonus.addClass('disabled');
        modeBonus.css('pointer-events', 'none');
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞ –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞ –Ω–∞ –∫–Ω–æ–ø–∫–µ
    function updateBonusCountdown() {
      if (!bonusNextAvailableTime) {
        return;
      }

      const now = new Date();
      const timeLeft = bonusNextAvailableTime - now;

      if (timeLeft <= 0) {
        // –í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ - –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        bonusNextAvailableTime = null;
        updateBonusGameStatus();
        return;
      }

      // –í—ã—á–∏—Å–ª—è–µ–º –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è
      const hours = Math.floor(timeLeft / (1000 * 60 * 60));
      const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –∫–Ω–æ–ø–∫–µ –≤ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞ –∏–≥—Ä—ã
      const bonusBadge = $('#bonusBadge');
      const bonusModeInfo = $('#bonusModeInfo');
      
      // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
      let timeText = '';
      let fullTimeText = '';
      if (hours > 0) {
        timeText = `${hours}—á ${String(minutes).padStart(2, '0')}–º`;
        fullTimeText = `–î–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑: ${hours}—á ${minutes}–º ${seconds}—Å`;
      } else if (minutes > 0) {
        timeText = `${minutes}–º ${String(seconds).padStart(2, '0')}—Å`;
        fullTimeText = `–î–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑: ${minutes}–º ${seconds}—Å`;
      } else {
        timeText = `${seconds}—Å`;
        fullTimeText = `–î–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑: ${seconds}—Å`;
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –≤ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞ –∏–≥—Ä—ã
      bonusBadge.text(`‚è∞ ${timeText}`);
      bonusModeInfo.text(fullTimeText);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–∫–∂–µ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ
      const bonusCountdown = $('#bonusCountdown');
      if (bonusCountdown.length > 0) {
        if (hours > 0) {
          bonusCountdown.text(`‚è∞ –î–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑: ${hours}—á ${minutes}–º ${seconds}—Å`);
        } else if (minutes > 0) {
          bonusCountdown.text(`‚è∞ –î–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑: ${minutes}–º ${seconds}—Å`);
        } else {
          bonusCountdown.text(`‚è∞ –î–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑: ${seconds}—Å`);
        }
      }
    }

    // –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞ –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞
    function startBonusCountdown() {
      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä –µ—Å–ª–∏ –µ—Å—Ç—å
      if (bonusCountdownInterval) {
        clearInterval(bonusCountdownInterval);
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
      bonusCountdownInterval = setInterval(() => {
        if (bonusNextAvailableTime) {
          updateBonusCountdown();
        } else {
          // –ï—Å–ª–∏ –≤—Ä–µ–º—è –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, –Ω–æ –∫–Ω–æ–ø–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞, –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
          const modeBonus = $('#modeBonus');
          if (modeBonus.hasClass('disabled')) {
            // –ü—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –≤—Ä–µ–º—è
            updateBonusGameStatus();
          }
        }
      }, 1000); // –ö–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
      if (bonusNextAvailableTime) {
        updateBonusCountdown();
      }
    }

    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–∞–π–º–µ—Ä–∞ –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞
    function stopBonusCountdown() {
      if (bonusCountdownInterval) {
        clearInterval(bonusCountdownInterval);
        bonusCountdownInterval = null;
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–¥–ø–∏—Å–∫–∏
    function showSubscriptionRequired(channelLink) {
      const channelName = channelLink.replace('@', '');
      const channelUrl = `https://t.me/${channelName}`;
      
      // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏
      const modalHtml = `
        <div id="subscriptionModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
          <div style="background: white; border-radius: 15px; padding: 2rem; max-width: 90%; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üì¢</div>
            <h2 style="color: #333; margin-bottom: 1rem;">–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª</h2>
            <p style="color: #666; margin-bottom: 1.5rem; line-height: 1.6;">
              –î–ª—è –∏–≥—Ä—ã –≤ Colizeum Tower Game –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –Ω–∞—à –∫–∞–Ω–∞–ª.<br><br>
              –ü–æ—Å–ª–µ –ø–æ–¥–ø–∏—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /start –≤ –±–æ—Ç–µ.
            </p>
            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
              <a href="${channelUrl}" target="_blank" style="background: #667eea; color: white; padding: 1rem 2rem; border-radius: 8px; text-decoration: none; font-weight: bold; display: inline-block;">
                üì¢ –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª
              </a>
              <button onclick="location.reload()" style="background: #28a745; color: white; padding: 1rem 2rem; border-radius: 8px; border: none; font-weight: bold; cursor: pointer;">
                üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
              </button>
            </div>
          </div>
        </div>
      `;
      
      // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ, –µ—Å–ª–∏ –µ—Å—Ç—å
      $('#subscriptionModal').remove();
      
      // –î–æ–±–∞–≤–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
      $('body').append(modalHtml);
      
      // –ë–ª–æ–∫–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø –∫ –∏–≥—Ä–µ
      $('#gameModeSelection').addClass('hide');
    }

    async function startGame(gameType) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –∏–≥—Ä—ã
      if (currentUser && currentUser.isSubscribed === false) {
        const channelLink = currentUser.channelLink || '@colizeum_kamensk_uralskiy';
        showSubscriptionRequired(channelLink);
        return;
      }

      if (gameType === 'bonus' && $('#modeBonus').hasClass('disabled')) {
        alert('–ò–≥—Ä–∞ –∑–∞ –±–æ–Ω—É—Å—ã –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ!');
        return;
      }

      // –î–ª—è –∏–≥—Ä—ã –∑–∞ –±–æ–Ω—É—Å—ã –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –ø–æ–ø—ã—Ç–∫—É —Å—Ä–∞–∑—É –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
      if (gameType === 'bonus' && authToken) {
        try {
          console.log('Starting bonus game, calling /api/game/bonus/start');
          const response = await fetch(`${API_BASE}/api/game/bonus/start`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${authToken}`,
              'Content-Type': 'application/json'
            }
          });

          console.log('Bonus game start response status:', response.status);

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—à–∏–±–∫—É –ø–æ–¥–ø–∏—Å–∫–∏
            if (response.status === 403 && errorData.error === 'Channel subscription required') {
              showSubscriptionRequired(errorData.channel || '@colizeum_kamensk_uralskiy');
              return;
            }
            let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É –∑–∞ –±–æ–Ω—É—Å—ã';
            try {
              const error = await response.json();
              console.error('Bonus game start error:', error);
              errorMessage = error.error || error.details || errorMessage;

              // –ï—Å–ª–∏ –∏–≥—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–æ–ª–µ–µ –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
              if (response.status === 403 && error.nextAvailable) {
                const nextAvailable = new Date(error.nextAvailable);
                const now = new Date();
                const hours = Math.floor((nextAvailable - now) / (1000 * 60 * 60));
                const minutes = Math.floor(((nextAvailable - now) % (1000 * 60 * 60)) / (1000 * 60));
                errorMessage = `–ò–≥—Ä–∞ –∑–∞ –±–æ–Ω—É—Å—ã –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ —á–µ—Ä–µ–∑ ${hours}—á ${minutes}–º`;
              }
            } catch (parseErr) {
              console.error('Error parsing error response:', parseErr);
              errorMessage = `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (${response.status}). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.`;
            }
            alert(errorMessage);
            return;
          }

          const result = await response.json();
          console.log('Bonus game started successfully:', result);
        } catch (err) {
          console.error('Start bonus game error:', err);
          alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
          return;
        }
      }

      currentGameType = gameType;
      console.log('startGame called with type:', gameType);

      // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–µ–Ω—é –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ
      $('#mainMenu').addClass('hide').css('display', 'none');
      $('#profileScreen').addClass('hide').css('display', 'none');
      $('.game-mode-selection').addClass('hide').css('display', 'none');
      $('#pauseModal').addClass('hide');
      $('#gameOverModal').addClass('hide');
      $('#profileScreen').addClass('hide');

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º canvas
      $('#canvas-container').removeClass('hide');
      $('#canvas').removeClass('hide');
      $('#btnPause').removeClass('hide');

      console.log('Menu hidden, canvas shown');

      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
      gameStart = false;
      score = 0;
      successCount = 0;
      perfectCount = 0;
      normalCount = 0;
      currentBonuses = 0;
      lastPerfectCount = 0;
      previousPerfectCount = 0;
      lastTrackedSuccessCount = 0;

      // –í—Å–µ–≥–¥–∞ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –∏–≥—Ä—É –ø—Ä–∏ —Å–º–µ–Ω–µ —Ä–µ–∂–∏–º–∞, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å infiniteLives
      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—É—é –∏–≥—Ä—É –µ—Å–ª–∏ –æ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
      if (game) {
        if (game.pauseBgm) {
          game.pauseBgm();
        }
        // –û—á–∏—â–∞–µ–º canvas
        if (game.ctx) {
          game.ctx.clearRect(0, 0, game.width || 0, game.height || 0);
        }
      }

      // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—Ç–∞—Ä—É—é –∏–≥—Ä—É –∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
      game = null;
      canvasReady = false;

      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∏–≥—Ä—É —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–∂–∏–º–∞
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ –∏–≥—Ä–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç –≤ –º–µ–Ω—é
      gameStart = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º, —á—Ç–æ–±—ã –∏–≥—Ä–∞ –º–æ–≥–ª–∞ –Ω–∞—á–∞—Ç—å—Å—è –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞ –Ω–∞ canvas
      initGame();

      console.log('Game initialized, waiting for canvas click to start');
    }

    // Game Initialization
    function initGame() {
      const gameWidth = window.innerWidth;
      const gameHeight = window.innerHeight;
      const ratio = 1.5;
      let finalWidth = gameWidth;
      if (gameHeight / gameWidth < ratio) {
        finalWidth = Math.ceil(gameHeight / ratio);
      }

      const option = {
        width: finalWidth,
        height: gameHeight,
        canvasId: 'canvas',
        soundOn: true,
        // –í –æ–±—ã—á–Ω–æ–π –∏–≥—Ä–µ –∂–∏–∑–Ω–∏ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ, –≤ –∏–≥—Ä–µ –∑–∞ –±–æ–Ω—É—Å—ã - 3 –∂–∏–∑–Ω–∏
        infiniteLives: currentGameType === 'normal',
        // –û—á–∫–∏: 1 –∑–∞ –æ–±—ã—á–Ω—ã–π –±–ª–æ–∫, 2 –∑–∞ perfect –±–ª–æ–∫
        successScore: 1,
        perfectScore: 2,
        setGameScore: function (s) {
          // –õ–æ–≥–∏—Ä—É–µ–º –í–°–ï –≤—ã–∑–æ–≤—ã, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å, –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ª–∏ —Ñ—É–Ω–∫—Ü–∏—è
          console.log('setGameScore CALLED with:', s, 'current score:', score, 'game exists:', !!game, 'gameStart:', gameStart);

          // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å—á–µ—Ç –∏–∑–º–µ–Ω–∏–ª—Å—è
          if (score === s) {
            console.log('setGameScore: score unchanged, skipping');
            return;
          }

          const oldScore = score;
          score = s;

          // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: –ø—Ä–æ–≤–µ—Ä—è–µ–º –±–ª–æ–∫–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å—á–µ—Ç —É–≤–µ–ª–∏—á–∏–ª—Å—è
          if (score <= oldScore) {
            console.log('setGameScore: score did not increase, skipping');
            return;
          }

          if (!game || !game.getVariable) {
            console.log('setGameScore: game or getVariable not available');
            return;
          }

          // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –±–ª–æ–∫–∏ –ø–æ –∏–∑–º–µ–Ω–µ–Ω–∏—é SUCCESS_COUNT
          try {
            const currentSuccessCount = game.getVariable('SUCCESS_COUNT', 0);
            const currentPerfectCount = game.getVariable('PERFECT_COUNT', 0);

            console.log('setGameScore called:', {
              score: score,
              oldScore: oldScore,
              currentSuccessCount: currentSuccessCount,
              lastTrackedSuccessCount: lastTrackedSuccessCount,
              currentPerfectCount: currentPerfectCount,
              previousPerfectCount: previousPerfectCount
            });

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ—è–≤–∏–ª—Å—è –ª–∏ –Ω–æ–≤—ã–π –±–ª–æ–∫ (successCount —É–≤–µ–ª–∏—á–∏–ª—Å—è)
            if (currentSuccessCount > lastTrackedSuccessCount) {
              // PERFECT_COUNT —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ addScore –ü–ï–†–ï–î –≤—ã–∑–æ–≤–æ–º setGameScore
              // –î–ª—è perfect –±–ª–æ–∫–∞: PERFECT_COUNT = lastPerfectCount + 1 (–≤—Å–µ–≥–¥–∞ > 0)
              // –î–ª—è –æ–±—ã—á–Ω–æ–≥–æ –±–ª–æ–∫–∞: PERFECT_COUNT = 0
              // –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞: –µ—Å–ª–∏ PERFECT_COUNT > 0, –∑–Ω–∞—á–∏—Ç —ç—Ç–æ perfect –±–ª–æ–∫

              if (currentPerfectCount > 0) {
                // Perfect –±–ª–æ–∫
                perfectCount++;
                const maxBonuses = 500;
                const bonusToAdd = 2; // 2 –±–æ–Ω—É—Å–∞ –∑–∞ perfect –±–ª–æ–∫
                if (currentGameType === 'normal') {
                  currentBonuses = Math.min(currentBonuses + bonusToAdd, maxBonuses);
                } else {
                  currentBonuses += bonusToAdd;
                }
                game.setVariable('GAME_BONUSES', currentBonuses);
                console.log('‚úÖ Perfect block! Bonuses:', currentBonuses, 'added:', bonusToAdd, 'PERFECT_COUNT:', currentPerfectCount);
              } else {
                // –û–±—ã—á–Ω—ã–π –±–ª–æ–∫
                normalCount++;
                const maxBonuses = 500;
                const bonusToAdd = 1; // 1 –±–æ–Ω—É—Å –∑–∞ –æ–±—ã—á–Ω—ã–π –±–ª–æ–∫
                if (currentGameType === 'normal') {
                  currentBonuses = Math.min(currentBonuses + bonusToAdd, maxBonuses);
                } else {
                  currentBonuses += bonusToAdd;
                }
                game.setVariable('GAME_BONUSES', currentBonuses);
                console.log('üì¶ Normal block! Bonuses:', currentBonuses, 'added:', bonusToAdd, 'PERFECT_COUNT:', currentPerfectCount);
              }

              // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ
              lastTrackedSuccessCount = currentSuccessCount;
              previousPerfectCount = currentPerfectCount;
            } else {
              console.log('No new block detected, successCount not increased');
            }
          } catch (e) {
            // –¢–∏—Ö–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            console.error('Error in setGameScore bonus calculation:', e);
          }
        },
        setGameSuccess: function (s) {
          successCount = s;
        },
        setGameFailed: function (f) {
          console.log('setGameFailed called with:', f, 'gameType:', currentGameType, 'gameStart:', gameStart, 'infiniteLives:', currentGameType === 'normal');
          // –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏–≥—Ä—ã, –µ—Å–ª–∏ –∏–≥—Ä–∞ –µ—â–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞
          if (!gameStart) {
            console.log('Game not started yet, ignoring setGameFailed');
            return;
          }
          // –í –∏–≥—Ä–µ –∑–∞ –±–æ–Ω—É—Å—ã –≤—ã–∑—ã–≤–∞–µ–º endGame –ø—Ä–∏ 3 –∂–∏–∑–Ω—è—Ö
          if (currentGameType === 'bonus' && f >= 3) {
            console.log('Bonus game ended with 3 lives, stopping game immediately...');
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–≥—Ä—É –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
            if (game && game.setVariable) {
              try {
                game.setVariable('GAME_START_NOW', false);
              } catch (e) {
                console.log('Error setting GAME_START_NOW:', e);
              }
            }
            // –í—ã–∑—ã–≤–∞–µ–º endGame –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ (–±–µ–∑ –≤—ã–∑–æ–≤–∞ endAnimate, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É)
            endGame();
          }
          // –í –æ–±—ã—á–Ω–æ–π –∏–≥—Ä–µ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∏–≥—Ä–∞—Ç—å –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
        }
      };

      function gameReady() {
        // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—Ç–∞—Ä—É—é –∏–≥—Ä—É –µ—Å–ª–∏ –æ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if (game) {
          try {
            if (game.pauseBgm) game.pauseBgm();
            if (game.ctx) {
              game.ctx.clearRect(0, 0, game.width || 0, game.height || 0);
            }
          } catch (e) {
            console.log('Error cleaning old game:', e);
          }
        }

        console.log('Creating TowerGame with option:', option);
        console.log('setGameScore in option:', typeof option.setGameScore);
        game = TowerGame(option);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ setGameScore –ø–µ—Ä–µ–¥–∞–ª—Å—è –≤ –∏–≥—Ä—É
        const gameUserOption = game ? game.getVariable('GAME_USER_OPTION') : null;
        console.log('Game created, gameUserOption:', gameUserOption);
        console.log('setGameScore in gameUserOption:', gameUserOption ? typeof gameUserOption.setGameScore : 'N/A');

        game.load(function () {
          game.init();
          // –£–±—Ä–∞–Ω–æ –∞–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–≤—É–∫–∞ - –±—É–¥–µ—Ç –≤–∫–ª—é—á–∞—Ç—å—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∏–≥—Ä—ã
          canvasReady = true;
          // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –Ω–æ hideLoading —É–∂–µ –≤—ã–∑–≤–∞–Ω–∞ –ø—Ä–∏ domReady
          // –ü—Ä–æ—Å—Ç–æ —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∑–∞–≥—Ä—É–∑–∫–∞ —Å–∫—Ä—ã—Ç–∞
          $('#loading').addClass('hide');
        }, updateLoading);
      }

      gameReady();
    }

    function updateLoading(status) {
      const success = status.success;
      const total = status.total;
      const failed = status.failed;

      if (failed > 0) {
        $('#loadingText').text('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤');
        return;
      }

      const percent = Math.min(parseInt((success / total) * 100), 100);
      $('#loadingPercent').css('width', percent + '%');
      $('#loadingText').text(`–ó–∞–≥—Ä—É–∑–∫–∞... ${percent}%`);

      // –ï—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (100%), —Å–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏
      if (percent >= 100) {
        setTimeout(function () {
          // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
          $('#loading').addClass('hide').css('display', 'none');
          // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞ –∏–≥—Ä—ã, –µ—Å–ª–∏ –∏–≥—Ä–∞ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞ –ò canvas —Å–∫—Ä—ã—Ç
          // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é, –µ—Å–ª–∏ –∏–≥—Ä–∞ —É–∂–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è (canvas –≤–∏–¥–µ–Ω)
          if (!gameStart && $('#canvas-container').hasClass('hide')) {
            showGameModeSelection();
          }
        }, 300);
      }
    }

    function hideLoading() {
      // –î–ª—è –Ω–∞—á–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–ª—å–∫–æ domReady
      // –ò–≥—Ä–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ä–µ–∂–∏–º–∞
      console.log('hideLoading called, domReady:', domReady, 'game:', game, 'gameStart:', gameStart);
      if (domReady) {
        setTimeout(function () {
          // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
          $('#loading').addClass('hide').css('display', 'none');
          // –ï—Å–ª–∏ –∏–≥—Ä–∞ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞ –ò canvas —Å–∫—Ä—ã—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞ –∏–≥—Ä—ã
          // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é, –µ—Å–ª–∏ –∏–≥—Ä–∞ —É–∂–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è (canvas –≤–∏–¥–µ–Ω)
          if (!gameStart && $('#canvas-container').hasClass('hide')) {
            showGameModeSelection();
          }
        }, 500);
      } else {
        // –ï—Å–ª–∏ domReady –µ—â–µ false, –ø–æ–ø—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
        setTimeout(function () {
          if (domReady) {
            hideLoading();
          }
        }, 100);
      }
    }

    function pauseGame() {
      console.log('pauseGame called, game:', !!game, 'gameStart:', gameStart, 'gameType:', currentGameType);

      if (!game || !gameStart) {
        console.log('Cannot pause: game not ready or not started');
        return;
      }

      // –°—Ç–∞–≤–∏–º –∏–≥—Ä—É –Ω–∞ –ø–∞—É–∑—É
      if (game.togglePaused) {
        try {
          game.togglePaused();
        } catch (e) {
          console.error('Error toggling pause:', e);
        }
      }

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–∞—É–∑—ã
      $('#pauseModal').removeClass('hide').css('display', 'flex');
      $('#canvas-container').addClass('hide');

      console.log('Game paused, modal shown');
    }

    function resumeGame() {
      if (!game || !gameStart) return;

      // –°–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–∞—É–∑—ã
      $('#pauseModal').addClass('hide');
      $('#canvas-container').removeClass('hide');

      // –°–Ω–∏–º–∞–µ–º –ø–∞—É–∑—É
      if (game.togglePaused) {
        game.togglePaused();
      }
    }

    function exitToMenu() {
      console.log('exitToMenu called, gameStart:', gameStart, 'game exists:', !!game);

      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–≥—Ä—É –°–†–ê–ó–£, —á—Ç–æ–±—ã showGameModeSelection –º–æ–≥ –ø–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é
      gameStart = false;

      if (game) {
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
        if (game.setVariable) {
          try {
            game.setVariable('GAME_START_NOW', false);
          } catch (e) {
            console.log('Error setting GAME_START_NOW:', e);
          }
        }

        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–≤—É–∫
        if (game.pauseBgm) {
          try {
            game.pauseBgm();
          } catch (e) {
            console.log('Error pausing BGM:', e);
          }
        }

        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–≥—Ä—É, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–∞ –ø–∞—É–∑–µ
        if (game.togglePaused && game.isPaused && game.isPaused()) {
          try {
            game.togglePaused();
          } catch (e) {
            console.log('Error toggling pause:', e);
          }
        }
      }

      // –°–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–∞—É–∑—ã –∏ –∫–Ω–æ–ø–∫—É –ø–∞—É–∑—ã
      $('#pauseModal').addClass('hide').css('display', 'none');
      $('#gameOverModal').addClass('hide').css('display', 'none');
      $('#canvas-container').addClass('hide');
      $('#canvas').addClass('hide');
      $('#btnPause').addClass('hide');

      // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º –º–µ–Ω—é, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å
      setTimeout(() => {
        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ gameStart —Å–±—Ä–æ—à–µ–Ω
        gameStart = false;
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (—ç–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞)
        console.log('Calling showGameModeSelection, gameStart:', gameStart);
        showGameModeSelection();
      }, 100);
    }

    async function endGame() {
      console.log('endGame called, gameStart:', gameStart, 'currentGameType:', currentGameType, 'score:', score);

      // –ù–µ –∑–∞–≤–µ—Ä—à–∞–µ–º –∏–≥—Ä—É, –µ—Å–ª–∏ –æ–Ω–∞ –µ—â–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞
      if (!gameStart) {
        console.log('Game not started, ignoring endGame call');
        return;
      }

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ –∏–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –°–†–ê–ó–£, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –≤—ã–∑–æ–≤—ã
      gameStart = false;

      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–≥—Ä—É –ø–æ–ª–Ω–æ—Å—Ç—å—é
      if (game) {
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
        if (game.setVariable) {
          try {
            game.setVariable('GAME_START_NOW', false);
          } catch (e) {
            console.log('Error setting GAME_START_NOW:', e);
          }
        }
        // –ù–ï –≤—ã–∑—ã–≤–∞–µ–º endAnimate, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∏–≥—Ä—ã
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–≤—É–∫
        if (game.pauseBgm) {
          try {
            game.pauseBgm();
          } catch (e) {
            console.log('Error pausing BGM:', e);
          }
        }
      }

      // Save game result
      console.log('Saving game result, authToken:', !!authToken, 'score:', score, 'floors:', successCount);
      if (authToken) {
        try {
          const response = await fetch(`${API_BASE}/api/game/save`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
              gameType: currentGameType,
              score: score,
              floors: successCount,
              perfectCount: perfectCount,
              normalCount: normalCount
            })
          });

          if (response.ok) {
            const data = await response.json();
            console.log('Game saved successfully, bonusesEarned:', data.bonusesEarned);

            showGameOverModal(data.bonusesEarned, currentGameType);

            // –ï—Å–ª–∏ —ç—Ç–æ –∏–≥—Ä–∞ –∑–∞ –±–æ–Ω—É—Å—ã, –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ü–û–°–õ–ï –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            if (currentGameType === 'bonus') {
              console.log('üéÆ [BONUS GAME] Game completed, updating bonus game status...');
              // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É—Å–ø–µ–ª–æ –ø–æ–∫–∞–∑–∞—Ç—å—Å—è
              setTimeout(() => {
                console.log('üéÆ [BONUS GAME] Calling updateBonusGameStatus() after game completion');
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ä–æ–µ –≤—Ä–µ–º—è, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤–æ–µ –∏–∑ API
                bonusNextAvailableTime = null;
                updateBonusGameStatus().then(() => {
                  console.log('üéÆ [BONUS GAME] Bonus game status updated after completion');
                  // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –∑–∞–Ω–æ–≤–æ
                  startBonusCountdown();
                });
              }, 1000); // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –¥–æ 1 —Å–µ–∫—É–Ω–¥—ã, —á—Ç–æ–±—ã —Å–µ—Ä–≤–µ—Ä —É—Å–ø–µ–ª –æ–±–Ω–æ–≤–∏—Ç—å last_attempt
            }
          } else {
            const errorData = await response.json().catch(() => ({}));
            console.log('Game save failed, status:', response.status, errorData);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—à–∏–±–∫—É –ø–æ–¥–ø–∏—Å–∫–∏
            if (response.status === 403 && errorData.error === 'Channel subscription required') {
              showSubscriptionRequired(errorData.channel || '@colizeum_kamensk_uralskiy');
              return;
            }
            
            showGameOverModal(0, currentGameType);

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            if (currentGameType === 'bonus') {
              setTimeout(() => {
                updateBonusGameStatus();
              }, 500);
            }
          }
        } catch (err) {
          console.error('Save game error:', err);
          showGameOverModal(0);
        }
      } else {
        console.log('No authToken, showing modal without saving');
        showGameOverModal(0);
      }
    }

    function showGameOverModal(bonusesEarned, gameType = null) {
      console.log('showGameOverModal called, bonusesEarned:', bonusesEarned, 'gameType:', gameType, 'score:', score);

      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–≥—Ä—É –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
      if (game) {
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
        if (game.setVariable) {
          try {
            game.setVariable('GAME_START_NOW', false);
          } catch (e) {
            console.log('Error setting GAME_START_NOW in showGameOverModal:', e);
          }
        }
        // –ù–ï –≤—ã–∑—ã–≤–∞–µ–º endAnimate, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–≤—É–∫
        if (game.pauseBgm) {
          try {
            game.pauseBgm();
          } catch (e) {
            console.log('Error pausing BGM in showGameOverModal:', e);
          }
        }
      }

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ –∏–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
      gameStart = false;

      // –°–∫—Ä—ã–≤–∞–µ–º canvas –∏ –∫–Ω–æ–ø–∫—É –ø–∞—É–∑—ã
      $('#canvas-container').addClass('hide');
      $('#btnPause').addClass('hide');

      // –°–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
      $('#pauseModal').addClass('hide');

      // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –±–æ–Ω—É—Å—ã –∏–∑ –∏–≥—Ä—ã
      let totalBonuses = 0;
      if (game && game.getVariable) {
        try {
          const gameBonuses = game.getVariable('GAME_BONUSES');
          totalBonuses = (gameBonuses !== undefined && gameBonuses !== null) ? gameBonuses : currentBonuses;
        } catch (e) {
          totalBonuses = currentBonuses;
        }
      } else {
        totalBonuses = currentBonuses;
      }

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–æ–Ω—É—Å—ã –≤–º–µ—Å—Ç–æ –æ—á–∫–æ–≤
      $('#finalScore').text(totalBonuses || 0);
      const bonusEarnedEl = $('#bonusEarned');

      // –î–ª—è –∏–≥—Ä—ã –∑–∞ –±–æ–Ω—É—Å—ã –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –±–æ–Ω—É—Å–∞—Ö (–¥–∞–∂–µ –µ—Å–ª–∏ 0)
      if (gameType === 'bonus') {
        bonusEarnedEl.removeClass('hide');
        if (bonusesEarned > 0) {
          bonusEarnedEl.html(`üéÅ –í—ã –ø–æ–ª—É—á–∏–ª–∏ <strong>${bonusesEarned}</strong> –±–æ–Ω—É—Å–æ–≤!`);
        } else {
          bonusEarnedEl.html(`üéÅ –ò–≥—Ä–∞ –∑–∞ –±–æ–Ω—É—Å—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ë–æ–Ω—É—Å—ã: <strong>${bonusesEarned}</strong>`);
        }
      } else if (bonusesEarned > 0) {
        bonusEarnedEl.removeClass('hide');
        bonusEarnedEl.html(`üéÅ –í—ã –ø–æ–ª—É—á–∏–ª–∏ <strong>${bonusesEarned}</strong> –±–æ–Ω—É—Å–æ–≤!`);
      } else {
        bonusEarnedEl.addClass('hide');
      }

      // –°–∫—Ä—ã–≤–∞–µ–º/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞" –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
      const btnPlayAgain = $('#btnPlayAgain');
      if (currentGameType === 'bonus') {
        // –í —Ä–µ–∂–∏–º–µ –∑–∞ –±–æ–Ω—É—Å—ã —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞", —Ç–∞–∫ –∫–∞–∫ –ø–æ–ø—ã—Ç–∫–∞ —Ä–∞–∑ –≤ 24 —á–∞—Å–∞
        btnPlayAgain.addClass('hide');
      } else {
        // –í –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        btnPlayAgain.removeClass('hide');
      }

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
      const modalEl = $('#gameOverModal');
      modalEl.removeClass('hide');
      modalEl.css('display', 'flex');
      modalEl.css('z-index', '10000');
      modalEl.css('pointer-events', 'auto');
      console.log('Game over modal shown, display:', modalEl.css('display'), 'z-index:', modalEl.css('z-index'), 'gameType:', currentGameType);

      // –î–ª—è –∏–≥—Ä—ã –∑–∞ –±–æ–Ω—É—Å—ã —Å—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å, —á—Ç–æ–±—ã —Ç–∞–π–º–µ—Ä –æ—Ç–æ–±—Ä–∞–∂–∞–ª—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –≤ –º–µ–Ω—é
      if (gameType === 'bonus') {
        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É—Å–ø–µ–ª–æ –ø–æ–∫–∞–∑–∞—Ç—å—Å—è
        setTimeout(() => {
          updateBonusGameStatus();
        }, 300);
      }
    }

    // Start game on click/touch - —Ç–æ–ª—å–∫–æ –Ω–∞ canvas
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, —Ç–∞–∫ –∫–∞–∫ canvas –º–æ–∂–µ—Ç –ø–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è
    $(document).on('click touchstart', '#canvas', function (e) {
      e.stopPropagation();
      e.preventDefault();

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤ –∏–≥—Ä–æ–≤–æ–º —ç–∫—Ä–∞–Ω–µ, –∞ –Ω–µ –≤ –º–µ–Ω—é
      // Zepto –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç :visible, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —á–µ—Ä–µ–∑ –∫–ª–∞—Å—Å –∏ display
      const gameModeSelection = $('#gameModeSelection');
      if (!gameModeSelection.hasClass('hide') && (gameModeSelection.css('display') === 'flex' || gameModeSelection.css('display') === 'block')) {
        console.log('Menu is visible, ignoring canvas click');
        return false;
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ canvas –≤–∏–¥–∏–º –∏ –∏–≥—Ä–∞ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞
      const canvasContainer = $('#canvas-container');
      if (canvasContainer.hasClass('hide') || canvasContainer.css('display') === 'none') {
        console.log('Canvas is hidden, ignoring click');
        return false;
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å canvas —á–µ—Ä–µ–∑ –∫–ª–∞—Å—Å (Zepto –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç :visible)
      if (game && !gameStart && !canvasContainer.hasClass('hide') && canvasReady) {
        console.log('Starting game on canvas click/touch');

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –î–û –≤—ã–∑–æ–≤–∞ game.start(), —á—Ç–æ–±—ã setGameFailed –Ω–µ –≤—ã–∑—ã–≤–∞–ª endGame
        gameStart = true;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—á–µ—Ç—á–∏–∫ –±–æ–Ω—É—Å–æ–≤ –≤ –∏–≥—Ä–µ (–≤—Å–µ–≥–¥–∞ 0 –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ)
        if (game && game.setVariable) {
          currentBonuses = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –±–æ–Ω—É—Å—ã –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
          previousPerfectCount = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ perfect –±–ª–æ–∫–æ–≤
          lastTrackedSuccessCount = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ successCount
          perfectCount = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫–∏
          normalCount = 0;
          game.setVariable('GAME_BONUSES', 0);
          console.log('Game started, bonuses reset to 0');
        }

        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤–æ–∑–≤—Ä–∞—Ç –≤ –º–µ–Ω—é
        $('.game-mode-selection').addClass('hide').css('display', 'none');

        // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–≤—É–∫–∞ –ø–æ—Å–ª–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (game && game.playBgm) {
          try {
            game.playBgm();
          } catch (e) {
            console.log('Sound play requires user interaction');
          }
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É
        try {
          game.start();
          console.log('Game started successfully, gameStart:', gameStart);
        } catch (error) {
          console.error('Error starting game:', error);
          gameStart = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        }
      }
    });

    // Window load
    window.addEventListener('load', function () {
      console.log('Window loaded');
      domReady = true;
      init();
      // –í—ã–∑—ã–≤–∞–µ–º hideLoading –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –≥–æ—Ç–æ–≤–æ
      setTimeout(function () {
        hideLoading();
      }, 100);
    }, false);

    // –¢–∞–∫–∂–µ –≤—ã–∑—ã–≤–∞–µ–º hideLoading –ø—Ä–∏ DOMContentLoaded –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      domReady = true;
      setTimeout(function () {
        hideLoading();
      }, 100);
    }
  </script>
</body>

</html>