const { Telegraf } = require('telegraf');
const config = require('./config');
const { getOrCreateUser } = require('./database');
const { generateToken } = require('./auth');

let bot = null;

if (config.telegramBotToken) {
  bot = new Telegraf(config.telegramBotToken);

  // –ö–æ–º–∞–Ω–¥–∞ /start
  bot.command('start', async (ctx) => {
    const chatId = ctx.chat.id;
    const user = ctx.from;

    try {
      await getOrCreateUser(user);
      
      const gameUrl = `${config.frontendUrl}?tgWebAppStartParam=${user.id}`;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ URL localhost (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
      const isLocalhost = config.frontendUrl.includes('localhost') || config.frontendUrl.includes('127.0.0.1');
      
      const welcomeMessage = 
        `‚ùÑÔ∏è <b>–ó–ò–ú–ù–ò–ô –ü–û–î–™–Å–ú</b> ‚ùÑÔ∏è\n\n` +
        `üéØ <b>"–ü–æ–¥–Ω–∏–º–∞–π—Å—è –≤—ã—à–µ - —Å–æ–±–∏—Ä–∞–π –±–æ–ª—å—à–µ –±–æ–Ω—É—Å–æ–≤!"</b>\n\n` +
        `üéÆ <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Colizeum Tower Game!</b>\n\n` +
        `üèóÔ∏è <b>–ö–æ–Ω—Ü–µ–ø—Ü–∏—è –∏–≥—Ä—ã:</b>\n` +
        `–ü–æ—Å—Ç—Ä–æ–π —Å–∞–º—É—é –≤—ã—Å–æ–∫—É—é –±–∞—à–Ω—é! –£–ø—Ä–∞–≤–ª—è–π –±–ª–æ–∫–æ–º, –Ω–∞–∂–∏–º–∞—è –≤ –Ω—É–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç. –ß–µ–º –≤—ã—à–µ –±–∞—à–Ω—è, —Ç–µ–º –±–æ–ª—å—à–µ –±–æ–Ω—É—Å–æ–≤ —Ç—ã –ø–æ–ª—É—á–∞–µ—à—å!\n\n` +
        `üé≤ <b>–ö–∞–∫ –∏–≥—Ä–∞—Ç—å:</b>\n` +
        `‚Ä¢ –ë–ª–æ–∫ —Ä–∞—Å–∫–∞—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ –≤–µ—Ä—ë–≤–∫–µ\n` +
        `‚Ä¢ –ù–∞–∂–º–∏ –≤ –Ω—É–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç, —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–ª–æ–∫\n` +
        `‚Ä¢ –ò–¥–µ–∞–ª—å–Ω–æ–µ –ø–æ–ø–∞–¥–∞–Ω–∏–µ (Perfect) –¥–∞—ë—Ç –±–æ–ª—å—à–µ –±–æ–Ω—É—Å–æ–≤\n` +
        `‚Ä¢ –ß–µ–º –≤—ã—à–µ –±–∞—à–Ω—è, —Ç–µ–º —Å–ª–æ–∂–Ω–µ–µ –∏–≥—Ä–∞—Ç—å\n\n` +
        `üí∞ <b>–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –±–æ–Ω—É—Å–æ–≤:</b>\n` +
        `‚Ä¢ –ó–∞ –æ–±—ã—á–Ω—ã–π –±–ª–æ–∫: <b>1 –±–æ–Ω—É—Å</b>\n` +
        `‚Ä¢ –ó–∞ –∏–¥–µ–∞–ª—å–Ω—ã–π –±–ª–æ–∫ (Perfect): <b>2 –±–æ–Ω—É—Å–∞</b>\n` +
        `‚Ä¢ –ë–æ–Ω—É—Å—ã –∫–æ–ø—è—Ç—Å—è –≤ –≤–∞—à–µ–º "–±–∞–Ω–∫–µ" –∏ –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è\n` +
        `‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è: <b>500 –±–æ–Ω—É—Å–æ–≤</b>\n\n` +
        `üéÅ <b>–ö–∞–∫ –≤—ã–≤–µ—Å—Ç–∏ –±–æ–Ω—É—Å—ã:</b>\n` +
        `1Ô∏è‚É£ –ù–∞–∫–æ–ø–∏—Ç–µ <b>500 –±–æ–Ω—É—Å–æ–≤</b> –≤ –∏–≥—Ä–µ\n` +
        `2Ô∏è‚É£ –ü–æ–ø–æ–ª–Ω–∏—Ç–µ –∏–≥—Ä–æ–≤–æ–π –±–∞–ª–∞–Ω—Å –Ω–∞ <b>50% –æ—Ç —Å—É–º–º—ã</b> (250 —Ä—É–±–ª–µ–π)\n` +
        `3Ô∏è‚É£ –ü–æ–¥–æ–π–¥–∏—Ç–µ –∫ —Ä–µ—Å–µ–ø—à–Ω—É –≤ –æ–¥–Ω–æ–º –∏–∑ –∫–ª—É–±–æ–≤:\n` +
        `   ‚Ä¢ –°—É–≤–æ—Ä–æ–≤–∞ 27–∞\n` +
        `   ‚Ä¢ –õ–µ–Ω–∏–Ω–∞ 26\n\n` +
        `‚è∞ <b>–í–∞–∂–Ω–æ:</b> –ò–≥—Ä–∞ –∑–∞ –±–æ–Ω—É—Å—ã –¥–æ—Å—Ç—É–ø–Ω–∞ <b>—Ç–æ–ª—å–∫–æ 1 —Ä–∞–∑ –≤ –¥–µ–Ω—å!</b>\n\n` +
        `üöÄ –ì–æ—Ç–æ–≤ –Ω–∞—á–∞—Ç—å —Å–≤–æ–π –ø–æ–¥—ä—ë–º –∫ –≤–µ—Ä—à–∏–Ω–µ?\n\n` +
        `–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å:`;
      
      if (isLocalhost) {
        // –î–ª—è localhost –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —Å–æ —Å—Å—ã–ª–∫–æ–π (–±–µ–∑ –∫–Ω–æ–ø–∫–∏)
        await ctx.reply(
          welcomeMessage + `\n\nüîó –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Å—ã–ª–∫—É –≤ –±—Ä–∞—É–∑–µ—Ä–µ:\n<a href="${gameUrl}">${gameUrl}</a>`,
          {
            parse_mode: 'HTML',
            disable_web_page_preview: true
          }
        );
      } else {
        // –î–ª—è production –∏—Å–ø–æ–ª—å–∑—É–µ–º Web App –∫–Ω–æ–ø–∫—É –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
        await ctx.reply(
          welcomeMessage,
          {
            parse_mode: 'HTML',
            reply_markup: {
              inline_keyboard: [
                [[
                  {
                    text: 'üéÆ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É',
                    web_app: { url: gameUrl }
                  }
                ]],
                [[
                  { text: 'üèóÔ∏è –ö–æ–Ω—Ü–µ–ø—Ü–∏—è –∏–≥—Ä—ã', callback_data: 'info_concept' },
                  { text: 'üé≤ –ö–∞–∫ –∏–≥—Ä–∞—Ç—å', callback_data: 'info_howtoplay' }
                ]],
                [[
                  { text: 'üí∞ –ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞', callback_data: 'info_bonus_system' },
                  { text: 'üéÅ –ö–∞–∫ –≤—ã–≤–µ—Å—Ç–∏ –±–æ–Ω—É—Å—ã', callback_data: 'info_withdrawal' }
                ]],
                [[
                  { text: 'üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', callback_data: 'show_stats' },
                  { text: '‚ùì –ü–æ–º–æ—â—å', callback_data: 'show_help' }
                ]]
              ]
            }
          }
        );
      }
    } catch (err) {
      console.error('Error in /start command:', err);
      await ctx.reply('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
    }
  });

  // –ö–æ–º–∞–Ω–¥–∞ /stats
  bot.command('stats', async (ctx) => {
    const chatId = ctx.chat.id;
    const user = ctx.from;

    try {
      const dbUser = await getOrCreateUser(user);
      const { getUserStats, getUserRank, canPlayBonusGame } = require('./database');
      const stats = await getUserStats(dbUser.id);
      const rank = await getUserRank(dbUser.id);
      const bonusInfo = await canPlayBonusGame(dbUser.id);

      let bonusStatus = '';
      if (bonusInfo.canPlay) {
        bonusStatus = '‚úÖ <b>–î–æ—Å—Ç—É–ø–Ω–æ —Å–µ–π—á–∞—Å!</b>\nüéÆ –ú–æ–∂–µ—Ç–µ –∏–≥—Ä–∞—Ç—å –∑–∞ –±–æ–Ω—É—Å—ã –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!';
      } else {
        const nextAvailable = new Date(bonusInfo.nextAvailable);
        const now = new Date();
        const hours = Math.floor((nextAvailable - now) / (1000 * 60 * 60));
        const minutes = Math.floor(((nextAvailable - now) % (1000 * 60 * 60)) / (1000 * 60));
        bonusStatus = `‚è∞ <b>–î–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑: ${hours}—á ${minutes}–º</b>\n‚è≥ –û—Å—Ç–∞–ª–æ—Å—å –ø–æ–¥–æ–∂–¥–∞—Ç—å –¥–æ —Å–ª–µ–¥—É—é—â–µ–π –∏–≥—Ä—ã –∑–∞ –±–æ–Ω—É—Å—ã`;
      }

      const totalBonuses = stats.total_bonuses || 0;
      const remaining = Math.max(0, 500 - totalBonuses);
      const progressBar = Math.floor((totalBonuses / 500) * 10);
      const progressBarFill = 'üü©'.repeat(progressBar);
      const progressBarEmpty = '‚¨ú'.repeat(10 - progressBar);

      await ctx.reply(
        `‚ùÑÔ∏è <b>–ó–ò–ú–ù–ò–ô –ü–û–î–™–Å–ú - –í–ê–®–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ê</b> ‚ùÑÔ∏è\n\n` +
        `üë§ <b>–ò–≥—Ä–æ–∫:</b> ${user.first_name || '–ò–≥—Ä–æ–∫'}\n\n` +
        `üìä <b>–ò–≥—Ä–æ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:</b>\n` +
        `üéÆ –í—Å–µ–≥–æ –∏–≥—Ä: <b>${stats.games_count || 0}</b>\n` +
        `üéÅ –ò–≥—Ä –∑–∞ –±–æ–Ω—É—Å—ã: <b>${stats.bonus_games_count || 0}</b>\n` +
        `‚≠ê –õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: <b>${stats.best_score || 0} —ç—Ç–∞–∂–µ–π</b>\n` +
        `üèÜ –ú–µ—Å—Ç–æ –≤ —Ç–æ–ø–µ: <b>${rank ? `#${rank}` : '-'}</b>\n\n` +
        `üí∞ <b>–ë–∞–Ω–∫ –±–æ–Ω—É—Å–æ–≤:</b> <b>${totalBonuses}</b> / 500\n` +
        `${progressBarFill}${progressBarEmpty}\n` +
        `${remaining > 0 ? `‚è≥ –û—Å—Ç–∞–ª–æ—Å—å –Ω–∞–∫–æ–ø–∏—Ç—å: <b>${remaining} –±–æ–Ω—É—Å–æ–≤</b> –¥–æ –≤—ã–≤–æ–¥–∞\n` : `‚úÖ –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –ª–∏–º–∏—Ç–∞ –≤ 500 –±–æ–Ω—É—Å–æ–≤!\n`}` +
        `\nüéÅ <b>–ò–≥—Ä–∞ –∑–∞ –±–æ–Ω—É—Å—ã:</b>\n${bonusStatus}\n\n` +
        `üí° <b>–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ:</b> –î–ª—è –≤—ã–≤–æ–¥–∞ –±–æ–Ω—É—Å–æ–≤ –Ω–∞–∫–æ–ø–∏—Ç–µ 500 –∏ –ø–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å –Ω–∞ 50% (250 —Ä—É–±–ª–µ–π) –≤ –∫–ª—É–±–µ.\n\n` +
        `üöÄ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã!`,
        {
          parse_mode: 'HTML'
        }
      );
    } catch (err) {
      console.error('Error in /stats command:', err);
      await ctx.reply('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.');
    }
  });

  // –ö–æ–º–∞–Ω–¥–∞ /help
  bot.command('help', async (ctx) => {
    await ctx.reply(
      `‚ùÑÔ∏è <b>–ó–ò–ú–ù–ò–ô –ü–û–î–™–Å–ú - –°–ü–†–ê–í–ö–ê</b> ‚ùÑÔ∏è\n\n` +
      `üìã <b>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n` +
      `/start - –ù–∞—á–∞—Ç—å –∏–≥—Ä—É –∏ —É–∑–Ω–∞—Ç—å –æ–± –∞–∫—Ü–∏–∏\n` +
      `/stats - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤–∞—à—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å\n` +
      `/help - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É\n\n` +
      `üéØ <b>–ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã:</b>\n` +
      `‚Ä¢ –ë–ª–æ–∫ —Ä–∞—Å–∫–∞—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ –≤–µ—Ä—ë–≤–∫–µ - —Å–ª–µ–¥–∏—Ç–µ –∑–∞ –µ–≥–æ –¥–≤–∏–∂–µ–Ω–∏–µ–º\n` +
      `‚Ä¢ –ù–∞–∂–º–∏—Ç–µ –≤ –Ω—É–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç, —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–ª–æ–∫ –Ω–∞ –±–∞—à–Ω—é\n` +
      `‚Ä¢ –ï—Å–ª–∏ –±–ª–æ–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ - –ø–æ–ª—É—á–∞–µ—Ç–µ <b>1 –±–æ–Ω—É—Å</b>\n` +
      `‚Ä¢ –ï—Å–ª–∏ –±–ª–æ–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–¥–µ–∞–ª—å–Ω–æ (Perfect) - –ø–æ–ª—É—á–∞–µ—Ç–µ <b>2 –±–æ–Ω—É—Å–∞</b>\n` +
      `‚Ä¢ –ß–µ–º –≤—ã—à–µ –±–∞—à–Ω—è, —Ç–µ–º —Å–ª–æ–∂–Ω–µ–µ –ø–æ–ø–∞—Å—Ç—å –∏–¥–µ–∞–ª—å–Ω–æ\n` +
      `‚Ä¢ –ë–∞—à–Ω—è —É–ø–∞–ª–∞? –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!\n\n` +
      `üí∞ <b>–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –±–æ–Ω—É—Å–æ–≤:</b>\n` +
      `‚Ä¢ –í—Å–µ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –±–æ–Ω—É—Å—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –≤–∞—à–µ–º "–±–∞–Ω–∫–µ"\n` +
      `‚Ä¢ –ë–æ–Ω—É—Å—ã –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è –æ—Ç –∏–≥—Ä—ã –∫ –∏–≥—Ä–µ\n` +
      `‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è: <b>500 –±–æ–Ω—É—Å–æ–≤</b>\n` +
      `‚Ä¢ –ü–æ—Å–ª–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è 500 –±–æ–Ω—É—Å–æ–≤ –Ω–æ–≤—ã–µ –Ω–µ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è (–¥–æ –≤—ã–≤–æ–¥–∞)\n\n` +
      `üéÅ <b>–ö–∞–∫ –≤—ã–≤–µ—Å—Ç–∏ –±–æ–Ω—É—Å—ã:</b>\n` +
      `1Ô∏è‚É£ –ù–∞–∫–æ–ø–∏—Ç–µ <b>500 –±–æ–Ω—É—Å–æ–≤</b> –≤ –∏–≥—Ä–µ\n` +
      `2Ô∏è‚É£ –ü–æ–ø–æ–ª–Ω–∏—Ç–µ –∏–≥—Ä–æ–≤–æ–π –±–∞–ª–∞–Ω—Å –Ω–∞ <b>50% –æ—Ç —Å—É–º–º—ã</b> (250 —Ä—É–±–ª–µ–π)\n` +
      `3Ô∏è‚É£ –ü–æ–¥–æ–π–¥–∏—Ç–µ –∫ —Ä–µ—Å–µ–ø—à–Ω—É –≤ –∫–ª—É–±–µ:\n` +
      `   ‚Ä¢ –°—É–≤–æ—Ä–æ–≤–∞ 27–∞\n` +
      `   ‚Ä¢ –õ–µ–Ω–∏–Ω–∞ 26\n` +
      `4Ô∏è‚É£ –ü–æ–ª—É—á–∏—Ç–µ —Å–≤–æ–∏ 500 –±–æ–Ω—É—Å–æ–≤!\n\n` +
      `‚è∞ <b>–í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞:</b>\n` +
      `‚Ä¢ –ò–≥—Ä–∞ –∑–∞ –±–æ–Ω—É—Å—ã –¥–æ—Å—Ç—É–ø–Ω–∞ <b>—Ç–æ–ª—å–∫–æ 1 —Ä–∞–∑ –≤ –¥–µ–Ω—å</b>\n` +
      `‚Ä¢ –û–±—ã—á–Ω–∞—è –∏–≥—Ä–∞ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π (–±–æ–Ω—É—Å—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è, –Ω–æ –∫–æ–ø—è—Ç—Å—è –¥–æ –ª–∏–º–∏—Ç–∞ 500)\n` +
      `‚Ä¢ –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏\n\n` +
      `üéÆ <b>–î–≤–∞ —Ä–µ–∂–∏–º–∞ –∏–≥—Ä—ã:</b>\n` +
      `‚Ä¢ <b>–û–±—ã—á–Ω–∞—è –∏–≥—Ä–∞</b> - —Ç—Ä–µ–Ω–∏—Ä—É–π—Ç–µ—Å—å –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π (–±–æ–Ω—É—Å—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è: 1 –∑–∞ –æ–±—ã—á–Ω—ã–π –±–ª–æ–∫, 2 –∑–∞ perfect, –∫–æ–ø—è—Ç—Å—è –¥–æ –ª–∏–º–∏—Ç–∞ 500)\n` +
      `‚Ä¢ <b>–ò–≥—Ä–∞ –∑–∞ –±–æ–Ω—É—Å—ã</b> - –∏–≥—Ä–∞–π—Ç–µ —Ä–∞–∑ –≤ –¥–µ–Ω—å –∏ –ø–æ–ª—É—á–∞–π—Ç–µ –±–æ–Ω—É—Å—ã –≤ –±–∞–Ω–∫\n\n` +
      `‚ùÑÔ∏è <b>"–ü–æ–¥–Ω–∏–º–∞–π—Å—è –≤—ã—à–µ - —Å–æ–±–∏—Ä–∞–π –±–æ–ª—å—à–µ –±–æ–Ω—É—Å–æ–≤!"</b> ‚ùÑÔ∏è`,
      {
        parse_mode: 'HTML'
      }
    );
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ callback –¥–ª—è –∫–Ω–æ–ø–æ–∫
  bot.action('info_concept', async (ctx) => {
    await ctx.answerCbQuery();
    await ctx.reply(
      `üèóÔ∏è <b>–ö–û–ù–¶–ï–ü–¶–ò–Ø –ò–ì–†–´</b>\n\n` +
      `–ü–æ—Å—Ç—Ä–æ–π —Å–∞–º—É—é –≤—ã—Å–æ–∫—É—é –±–∞—à–Ω—é! –£–ø—Ä–∞–≤–ª—è–π –±–ª–æ–∫–æ–º, –Ω–∞–∂–∏–º–∞—è –≤ –Ω—É–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç. –ß–µ–º –≤—ã—à–µ –±–∞—à–Ω—è, —Ç–µ–º –±–æ–ª—å—à–µ –±–æ–Ω—É—Å–æ–≤ —Ç—ã –ø–æ–ª—É—á–∞–µ—à—å!\n\n` +
      `üéØ –¶–µ–ª—å: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞–∫ –º–æ–∂–Ω–æ –±–æ–ª—å—à–µ –±–ª–æ–∫–æ–≤, –ø–æ—Å—Ç—Ä–æ–∏–≤ —Å–∞–º—É—é –≤—ã—Å–æ–∫—É—é –±–∞—à–Ω—é!\n\n` +
      `üí° –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - —Å–ª–µ–¥–∏—Ç—å –∑–∞ –¥–≤–∏–∂–µ–Ω–∏–µ–º –±–ª–æ–∫–∞ –∏ –Ω–∞–∂–∏–º–∞—Ç—å –≤ –Ω—É–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç –¥–ª—è –µ–≥–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏.`,
      {
        parse_mode: 'HTML'
      }
    );
  });

  bot.action('info_howtoplay', async (ctx) => {
    await ctx.answerCbQuery();
    await ctx.reply(
      `üé≤ <b>–ö–ê–ö –ò–ì–†–ê–¢–¨</b>\n\n` +
      `1Ô∏è‚É£ –ë–ª–æ–∫ —Ä–∞—Å–∫–∞—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ –≤–µ—Ä—ë–≤–∫–µ\n` +
      `2Ô∏è‚É£ –°–ª–µ–¥–∏ –∑–∞ –µ–≥–æ –¥–≤–∏–∂–µ–Ω–∏–µ–º\n` +
      `3Ô∏è‚É£ –ù–∞–∂–º–∏ –≤ –Ω—É–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç, —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–ª–æ–∫\n` +
      `4Ô∏è‚É£ –ò–¥–µ–∞–ª—å–Ω–æ–µ –ø–æ–ø–∞–¥–∞–Ω–∏–µ (Perfect) –¥–∞—ë—Ç –±–æ–ª—å—à–µ –±–æ–Ω—É—Å–æ–≤\n` +
      `5Ô∏è‚É£ –ß–µ–º –≤—ã—à–µ –±–∞—à–Ω—è, —Ç–µ–º —Å–ª–æ–∂–Ω–µ–µ –∏–≥—Ä–∞—Ç—å\n\n` +
      `‚ö†Ô∏è –ï—Å–ª–∏ –±–ª–æ–∫ —É–ø–∞–ª –º–∏–º–æ –±–∞—à–Ω–∏ - –∏–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!`,
      {
        parse_mode: 'HTML'
      }
    );
  });

  bot.action('info_bonus_system', async (ctx) => {
    await ctx.answerCbQuery();
    await ctx.reply(
      `üí∞ <b>–ù–ê–ö–û–ü–ò–¢–ï–õ–¨–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –ë–û–ù–£–°–û–í</b>\n\n` +
      `üéØ <b>–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–æ–Ω—É—Å–æ–≤:</b>\n` +
      `‚Ä¢ –ó–∞ –æ–±—ã—á–Ω—ã–π –±–ª–æ–∫: <b>1 –±–æ–Ω—É—Å</b>\n` +
      `‚Ä¢ –ó–∞ –∏–¥–µ–∞–ª—å–Ω—ã–π –±–ª–æ–∫ (Perfect): <b>2 –±–æ–Ω—É—Å–∞</b>\n\n` +
      `üè¶ <b>–ë–∞–Ω–∫ –±–æ–Ω—É—Å–æ–≤:</b>\n` +
      `‚Ä¢ –ë–æ–Ω—É—Å—ã –∫–æ–ø—è—Ç—Å—è –≤ –≤–∞—à–µ–º "–±–∞–Ω–∫–µ" –∏ –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è\n` +
      `‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è: <b>500 –±–æ–Ω—É—Å–æ–≤</b>\n` +
      `‚Ä¢ –ü–æ—Å–ª–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è 500 –±–æ–Ω—É—Å–æ–≤ –Ω–æ–≤—ã–µ –Ω–µ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è (–¥–æ –≤—ã–≤–æ–¥–∞)\n\n` +
      `üí° –í—Å–µ –±–æ–Ω—É—Å—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –º–µ–∂–¥—É –∏–≥—Ä–∞–º–∏!`,
      {
        parse_mode: 'HTML'
      }
    );
  });

  bot.action('info_withdrawal', async (ctx) => {
    await ctx.answerCbQuery();
    await ctx.reply(
      `üéÅ <b>–ö–ê–ö –í–´–í–ï–°–¢–ò –ë–û–ù–£–°–´</b>\n\n` +
      `üìã <b>–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:</b>\n\n` +
      `1Ô∏è‚É£ –ù–∞–∫–æ–ø–∏—Ç–µ <b>500 –±–æ–Ω—É—Å–æ–≤</b> –≤ –∏–≥—Ä–µ\n\n` +
      `2Ô∏è‚É£ –ü–æ–ø–æ–ª–Ω–∏—Ç–µ –∏–≥—Ä–æ–≤–æ–π –±–∞–ª–∞–Ω—Å –Ω–∞ <b>50% –æ—Ç —Å—É–º–º—ã</b>\n` +
      `   üí∞ –≠—Ç–æ <b>250 —Ä—É–±–ª–µ–π</b> (50% –æ—Ç 500 –±–æ–Ω—É—Å–æ–≤)\n\n` +
      `3Ô∏è‚É£ –ü–æ–¥–æ–π–¥–∏—Ç–µ –∫ —Ä–µ—Å–µ–ø—à–Ω—É –≤ –æ–¥–Ω–æ–º –∏–∑ –∫–ª—É–±–æ–≤:\n` +
      `   üè¢ –°—É–≤–æ—Ä–æ–≤–∞ 27–∞\n` +
      `   üè¢ –õ–µ–Ω–∏–Ω–∞ 26\n\n` +
      `4Ô∏è‚É£ –°–∫–∞–∂–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–≤–µ—Å—Ç–∏ –±–æ–Ω—É—Å—ã –∏–∑ –∏–≥—Ä—ã\n\n` +
      `5Ô∏è‚É£ –ü–æ–ª—É—á–∏—Ç–µ —Å–≤–æ–∏ <b>500 –±–æ–Ω—É—Å–æ–≤</b>! üéä\n\n` +
      `‚è∞ <b>–í–∞–∂–Ω–æ:</b> –ò–≥—Ä–∞ –∑–∞ –±–æ–Ω—É—Å—ã –¥–æ—Å—Ç—É–ø–Ω–∞ <b>—Ç–æ–ª—å–∫–æ 1 —Ä–∞–∑ –≤ –¥–µ–Ω—å</b>!`,
      {
        parse_mode: 'HTML'
      }
    );
  });

  bot.action('show_stats', async (ctx) => {
    await ctx.answerCbQuery();
    const user = ctx.from;
    try {
      const dbUser = await getOrCreateUser(user);
      const { getUserStats, getUserRank, canPlayBonusGame } = require('./database');
      const stats = await getUserStats(dbUser.id);
      const rank = await getUserRank(dbUser.id);
      const bonusInfo = await canPlayBonusGame(dbUser.id);

      let bonusStatus = '';
      if (bonusInfo.canPlay) {
        bonusStatus = '‚úÖ <b>–î–æ—Å—Ç—É–ø–Ω–æ —Å–µ–π—á–∞—Å!</b>\nüéÆ –ú–æ–∂–µ—Ç–µ –∏–≥—Ä–∞—Ç—å –∑–∞ –±–æ–Ω—É—Å—ã –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!';
      } else {
        const nextAvailable = new Date(bonusInfo.nextAvailable);
        const now = new Date();
        const hours = Math.floor((nextAvailable - now) / (1000 * 60 * 60));
        const minutes = Math.floor(((nextAvailable - now) % (1000 * 60 * 60)) / (1000 * 60));
        bonusStatus = `‚è∞ <b>–î–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑: ${hours}—á ${minutes}–º</b>\n‚è≥ –û—Å—Ç–∞–ª–æ—Å—å –ø–æ–¥–æ–∂–¥–∞—Ç—å –¥–æ —Å–ª–µ–¥—É—é—â–µ–π –∏–≥—Ä—ã –∑–∞ –±–æ–Ω—É—Å—ã`;
      }

      const totalBonuses = stats.total_bonuses || 0;
      const remaining = Math.max(0, 500 - totalBonuses);
      const progressBar = Math.floor((totalBonuses / 500) * 10);
      const progressBarFill = 'üü©'.repeat(progressBar);
      const progressBarEmpty = '‚¨ú'.repeat(10 - progressBar);

      await ctx.reply(
        `‚ùÑÔ∏è <b>–ó–ò–ú–ù–ò–ô –ü–û–î–™–Å–ú - –í–ê–®–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ê</b> ‚ùÑÔ∏è\n\n` +
        `üë§ <b>–ò–≥—Ä–æ–∫:</b> ${user.first_name || '–ò–≥—Ä–æ–∫'}\n\n` +
        `üìä <b>–ò–≥—Ä–æ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:</b>\n` +
        `üéÆ –í—Å–µ–≥–æ –∏–≥—Ä: <b>${stats.games_count || 0}</b>\n` +
        `üéÅ –ò–≥—Ä –∑–∞ –±–æ–Ω—É—Å—ã: <b>${stats.bonus_games_count || 0}</b>\n` +
        `‚≠ê –õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: <b>${stats.best_score || 0} —ç—Ç–∞–∂–µ–π</b>\n` +
        `üèÜ –ú–µ—Å—Ç–æ –≤ —Ç–æ–ø–µ: <b>${rank ? `#${rank}` : '-'}</b>\n\n` +
        `üí∞ <b>–ë–∞–Ω–∫ –±–æ–Ω—É—Å–æ–≤:</b> <b>${totalBonuses}</b> / 500\n` +
        `${progressBarFill}${progressBarEmpty}\n` +
        `${remaining > 0 ? `‚è≥ –û—Å—Ç–∞–ª–æ—Å—å –Ω–∞–∫–æ–ø–∏—Ç—å: <b>${remaining} –±–æ–Ω—É—Å–æ–≤</b> –¥–æ –≤—ã–≤–æ–¥–∞\n` : `‚úÖ –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –ª–∏–º–∏—Ç–∞ –≤ 500 –±–æ–Ω—É—Å–æ–≤!\n`}` +
        `\nüéÅ <b>–ò–≥—Ä–∞ –∑–∞ –±–æ–Ω—É—Å—ã:</b>\n${bonusStatus}\n\n` +
        `üí° <b>–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ:</b> –î–ª—è –≤—ã–≤–æ–¥–∞ –±–æ–Ω—É—Å–æ–≤ –Ω–∞–∫–æ–ø–∏—Ç–µ 500 –∏ –ø–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å –Ω–∞ 50% (250 —Ä—É–±–ª–µ–π) –≤ –∫–ª—É–±–µ.`,
        {
          parse_mode: 'HTML'
        }
      );
    } catch (err) {
      console.error('Error in show_stats callback:', err);
      await ctx.reply('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.');
    }
  });

  bot.action('show_help', async (ctx) => {
    await ctx.answerCbQuery();
    await ctx.reply(
      `‚ùÑÔ∏è <b>–ó–ò–ú–ù–ò–ô –ü–û–î–™–Å–ú - –°–ü–†–ê–í–ö–ê</b> ‚ùÑÔ∏è\n\n` +
      `üìã <b>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n` +
      `/start - –ù–∞—á–∞—Ç—å –∏–≥—Ä—É –∏ —É–∑–Ω–∞—Ç—å –æ–± –∞–∫—Ü–∏–∏\n` +
      `/stats - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤–∞—à—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å\n` +
      `/help - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É\n\n` +
      `üéØ <b>–ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã:</b>\n` +
      `‚Ä¢ –ë–ª–æ–∫ —Ä–∞—Å–∫–∞—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ –≤–µ—Ä—ë–≤–∫–µ - —Å–ª–µ–¥–∏—Ç–µ –∑–∞ –µ–≥–æ –¥–≤–∏–∂–µ–Ω–∏–µ–º\n` +
      `‚Ä¢ –ù–∞–∂–º–∏—Ç–µ –≤ –Ω—É–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç, —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–ª–æ–∫ –Ω–∞ –±–∞—à–Ω—é\n` +
      `‚Ä¢ –ï—Å–ª–∏ –±–ª–æ–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ - –ø–æ–ª—É—á–∞–µ—Ç–µ <b>1 –±–æ–Ω—É—Å</b>\n` +
      `‚Ä¢ –ï—Å–ª–∏ –±–ª–æ–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–¥–µ–∞–ª—å–Ω–æ (Perfect) - –ø–æ–ª—É—á–∞–µ—Ç–µ <b>2 –±–æ–Ω—É—Å–∞</b>\n` +
      `‚Ä¢ –ß–µ–º –≤—ã—à–µ –±–∞—à–Ω—è, —Ç–µ–º —Å–ª–æ–∂–Ω–µ–µ –ø–æ–ø–∞—Å—Ç—å –∏–¥–µ–∞–ª—å–Ω–æ\n` +
      `‚Ä¢ –ë–∞—à–Ω—è —É–ø–∞–ª–∞? –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!\n\n` +
      `üí∞ <b>–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –±–æ–Ω—É—Å–æ–≤:</b>\n` +
      `‚Ä¢ –í—Å–µ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –±–æ–Ω—É—Å—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –≤–∞—à–µ–º "–±–∞–Ω–∫–µ"\n` +
      `‚Ä¢ –ë–æ–Ω—É—Å—ã –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è –æ—Ç –∏–≥—Ä—ã –∫ –∏–≥—Ä–µ\n` +
      `‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è: <b>500 –±–æ–Ω—É—Å–æ–≤</b>\n` +
      `‚Ä¢ –ü–æ—Å–ª–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è 500 –±–æ–Ω—É—Å–æ–≤ –Ω–æ–≤—ã–µ –Ω–µ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è (–¥–æ –≤—ã–≤–æ–¥–∞)\n\n` +
      `üéÅ <b>–ö–∞–∫ –≤—ã–≤–µ—Å—Ç–∏ –±–æ–Ω—É—Å—ã:</b>\n` +
      `1Ô∏è‚É£ –ù–∞–∫–æ–ø–∏—Ç–µ <b>500 –±–æ–Ω—É—Å–æ–≤</b> –≤ –∏–≥—Ä–µ\n` +
      `2Ô∏è‚É£ –ü–æ–ø–æ–ª–Ω–∏—Ç–µ –∏–≥—Ä–æ–≤–æ–π –±–∞–ª–∞–Ω—Å –Ω–∞ <b>50% –æ—Ç —Å—É–º–º—ã</b> (250 —Ä—É–±–ª–µ–π)\n` +
      `3Ô∏è‚É£ –ü–æ–¥–æ–π–¥–∏—Ç–µ –∫ —Ä–µ—Å–µ–ø—à–Ω—É –≤ –∫–ª—É–±–µ:\n` +
      `   ‚Ä¢ –°—É–≤–æ—Ä–æ–≤–∞ 27–∞\n` +
      `   ‚Ä¢ –õ–µ–Ω–∏–Ω–∞ 26\n` +
      `4Ô∏è‚É£ –ü–æ–ª—É—á–∏—Ç–µ —Å–≤–æ–∏ 500 –±–æ–Ω—É—Å–æ–≤!\n\n` +
      `‚è∞ <b>–í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞:</b>\n` +
      `‚Ä¢ –ò–≥—Ä–∞ –∑–∞ –±–æ–Ω—É—Å—ã –¥–æ—Å—Ç—É–ø–Ω–∞ <b>—Ç–æ–ª—å–∫–æ 1 —Ä–∞–∑ –≤ –¥–µ–Ω—å</b>\n` +
      `‚Ä¢ –û–±—ã—á–Ω–∞—è –∏–≥—Ä–∞ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π (–±–æ–Ω—É—Å—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è, –Ω–æ –∫–æ–ø—è—Ç—Å—è –¥–æ –ª–∏–º–∏—Ç–∞ 500)\n` +
      `‚Ä¢ –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏\n\n` +
      `üéÆ <b>–î–≤–∞ —Ä–µ–∂–∏–º–∞ –∏–≥—Ä—ã:</b>\n` +
      `‚Ä¢ <b>–û–±—ã—á–Ω–∞—è –∏–≥—Ä–∞</b> - —Ç—Ä–µ–Ω–∏—Ä—É–π—Ç–µ—Å—å –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π (–±–æ–Ω—É—Å—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è: 1 –∑–∞ –æ–±—ã—á–Ω—ã–π –±–ª–æ–∫, 2 –∑–∞ perfect, –∫–æ–ø—è—Ç—Å—è –¥–æ –ª–∏–º–∏—Ç–∞ 500)\n` +
      `‚Ä¢ <b>–ò–≥—Ä–∞ –∑–∞ –±–æ–Ω—É—Å—ã</b> - –∏–≥—Ä–∞–π—Ç–µ —Ä–∞–∑ –≤ –¥–µ–Ω—å –∏ –ø–æ–ª—É—á–∞–π—Ç–µ –±–æ–Ω—É—Å—ã –≤ –±–∞–Ω–∫\n\n` +
      `‚ùÑÔ∏è <b>"–ü–æ–¥–Ω–∏–º–∞–π—Å—è –≤—ã—à–µ - —Å–æ–±–∏—Ä–∞–π –±–æ–ª—å—à–µ –±–æ–Ω—É—Å–æ–≤!"</b> ‚ùÑÔ∏è`,
      {
        parse_mode: 'HTML'
      }
    );
  });

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–∏ webhook
  const useWebhook = config.telegramWebhookUrl && !config.telegramWebhookUrl.includes('localhost');
  
  if (useWebhook) {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º webhook –¥–ª—è production (webhook –±—É–¥–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ server.js)
    console.log('‚úÖ Telegram bot configured for webhook mode');
    console.log(`ü§ñ Webhook URL will be set to: ${config.telegramWebhookUrl}/webhook`);
    // –ù–µ –∑–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ –∑–¥–µ—Å—å, webhook –±—É–¥–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ server.js –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
  } else {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º polling –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
    bot.launch().then(() => {
      console.log('‚úÖ Telegram bot initialized and started successfully (polling mode)');
      console.log(`ü§ñ Bot is ready! Use /start command in Telegram`);
    }).catch((err) => {
      console.error('‚ùå Error starting bot:', err);
      console.error('Error details:', err.message);
      if (err.response) {
        console.error('Telegram API response:', err.response);
      }
    });
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –±–æ—Ç–∞
  bot.catch((err, ctx) => {
    console.error('Bot error occurred:', err);
    console.error('Update:', ctx.update);
  });

  // Graceful stop (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±–æ—Ç –∑–∞–ø—É—â–µ–Ω –≤ polling —Ä–µ–∂–∏–º–µ)
  const gracefulStop = async (signal) => {
    try {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ –±–æ—Ç (—Ç–æ–ª—å–∫–æ –¥–ª—è polling —Ä–µ–∂–∏–º–∞)
      if (!useWebhook) {
        await bot.stop(signal);
        console.log(`Bot stopped gracefully with ${signal}`);
      } else {
        // –î–ª—è webhook —Ä–µ–∂–∏–º–∞ –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º webhook
        console.log(`Bot webhook mode - graceful shutdown with ${signal}`);
      }
    } catch (err) {
      // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –±–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω
      if (err.message && err.message.includes('Bot is not running')) {
        console.log(`Bot not running, skipping stop (${signal})`);
      } else {
        console.error(`Error stopping bot (${signal}):`, err);
      }
    }
  };
  
  process.once('SIGINT', () => gracefulStop('SIGINT'));
  process.once('SIGTERM', () => gracefulStop('SIGTERM'));
} else {
  console.warn('Telegram bot token not provided. Bot will not work.');
}

module.exports = bot;
